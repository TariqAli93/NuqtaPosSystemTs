diff --git a/apps/electron/electron.vite.config.ts b/apps/electron/electron.vite.config.ts
index cec3619..9e2cd51 100644
--- a/apps/electron/electron.vite.config.ts
+++ b/apps/electron/electron.vite.config.ts
@@ -32,7 +32,7 @@ export default defineConfig({
     plugins: [
       vue(),
       vueDevTools({
-        launchEditor: path.resolve(__dirname, '../tools/antigravity-editor.cmd'),
+        // launchEditor: path.resolve(__dirname, '../tools/antigravity-editor.cmd'),
       }),
       tailwindcss(),
       vuetify({
diff --git a/apps/electron/package.json b/apps/electron/package.json
index 0c313a8..12e04d5 100644
--- a/apps/electron/package.json
+++ b/apps/electron/package.json
@@ -13,7 +13,7 @@
   "scripts": {
     "rebuild:sqlite": "electron-rebuild -f -w better-sqlite3 --module-dir ../../packages/data",
     "dev": "pnpm run rebuild:sqlite && electron-vite dev --watch",
-    "build": "pnpm run rebuild:sqlite && electron-vite build && electron-builder --config electron-builder.yml --publish never",
+    "build": "pnpm run rebuild:sqlite && electron-vite build",
     "dist": "pnpm run rebuild:sqlite && electron-builder --config electron-builder.yml"
   },
   "dependencies": {
diff --git a/apps/electron/src/ipc/AuthHandler.ts b/apps/electron/src/ipc/AuthHandler.ts
index 50a851d..ea290e2 100644
--- a/apps/electron/src/ipc/AuthHandler.ts
+++ b/apps/electron/src/ipc/AuthHandler.ts
@@ -205,8 +205,8 @@ export function registerAuthHandlers(db: DatabaseType) {
   ipcMain.handle('setup:setAccountingEnabled', async (_event, payload) => {
     try {
       const setupStatus = checkInitialSetupUseCase.execute();
-      if (setupStatus.isInitialized || setupStatus.hasUsers) {
-        throw new Error('Cannot update setup settings: application already initialized');
+      if (setupStatus.wizardCompleted) {
+        throw new Error('Cannot update setup settings: setup wizard already completed');
       }
 
       const { data } = assertPayload('setup:setAccountingEnabled', payload, ['data']);
@@ -220,6 +220,7 @@ export function registerAuthHandlers(db: DatabaseType) {
       }
 
       settingsRepo.set('accounting.enabled', body.enabled ? 'true' : 'false');
+      settingsRepo.set('modules.accounting.enabled', body.enabled ? 'true' : 'false');
       if (!body.enabled) {
         settingsRepo.set('accounting.coaSeeded', 'false');
       }
@@ -233,8 +234,8 @@ export function registerAuthHandlers(db: DatabaseType) {
   ipcMain.handle('setup:seedChartOfAccounts', async (_event, payload) => {
     try {
       const setupStatus = checkInitialSetupUseCase.execute();
-      if (setupStatus.isInitialized || setupStatus.hasUsers) {
-        throw new Error('Cannot seed chart of accounts: application already initialized');
+      if (setupStatus.wizardCompleted) {
+        throw new Error('Cannot seed chart of accounts: setup wizard already completed');
       }
 
       const body = assertPayload('setup:seedChartOfAccounts', payload, ['data']);
diff --git a/apps/electron/src/ipc/CustomerHandler.ts b/apps/electron/src/ipc/CustomerHandler.ts
index 8e3c806..a3e5d83 100644
--- a/apps/electron/src/ipc/CustomerHandler.ts
+++ b/apps/electron/src/ipc/CustomerHandler.ts
@@ -105,6 +105,23 @@ export function registerCustomerHandlers(db: DatabaseType) {
     }
   });
 
+  ipcMain.handle('customers:getById', async (_event, payload) => {
+    try {
+      requirePermission({ permission: 'customers:read' });
+
+      const { id } = assertPayload('customers:getById', payload, ['id']);
+      const customerId = Number(id);
+      if (!Number.isFinite(customerId)) {
+        throw buildValidationError('customers:getById', payload, 'id must be a number');
+      }
+
+      const customer = customerRepo.findById(customerId);
+      return ok(customer);
+    } catch (error: unknown) {
+      return mapErrorToIpcResponse(error);
+    }
+  });
+
   ipcMain.handle('customers:create', async (_event, params) => {
     try {
       requirePermission({ permission: 'customers:create' });
diff --git a/apps/electron/src/ipc/DiagnosticsHandler.ts b/apps/electron/src/ipc/DiagnosticsHandler.ts
index 8b520e7..1efa120 100644
--- a/apps/electron/src/ipc/DiagnosticsHandler.ts
+++ b/apps/electron/src/ipc/DiagnosticsHandler.ts
@@ -14,6 +14,7 @@ import {
   SqliteAuditRepository,
   SqliteCustomerLedgerRepository,
   SqliteCustomerRepository,
+  SqliteFifoService,
   SqliteInventoryRepository,
   SqlitePaymentRepository,
   SqliteProductRepository,
@@ -67,12 +68,14 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
       const warnings: string[] = [];
       const countByTable = new Map(tables.map((item) => [item.table, item.rowCount]));
 
-      const accountsRow = db.sqlite
-        .prepare('SELECT COUNT(*) AS rowCount FROM accounts')
-        .get() as { rowCount?: number } | undefined;
+      const accountsRow = db.sqlite.prepare('SELECT COUNT(*) AS rowCount FROM accounts').get() as
+        | { rowCount?: number }
+        | undefined;
       const accountsCount = accountsRow?.rowCount || 0;
       if (accountsCount === 0) {
-        warnings.push('Chart of accounts is empty; journal entries will be skipped until accounts are seeded.');
+        warnings.push(
+          'Chart of accounts is empty; journal entries will be skipped until accounts are seeded.'
+        );
       } else {
         const requiredAccountCodes = ['1001', '1100', '1200', '4001', '5001', '2001', '2100'];
         const placeholders = requiredAccountCodes.map(() => '?').join(', ');
@@ -89,7 +92,9 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
 
         const hasAp = presentCodes.has('2001') || presentCodes.has('2100');
         if (!hasAp) {
-          warnings.push('Missing accounts payable code (2001 or 2100); purchase journals may be skipped.');
+          warnings.push(
+            'Missing accounts payable code (2001 or 2100); purchase journals may be skipped.'
+          );
         }
       }
 
@@ -131,6 +136,7 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
     const accountingRepo = new SqliteAccountingRepository(db.db);
     const customerLedgerRepo = new SqliteCustomerLedgerRepository(db.db);
     const auditRepo = new SqliteAuditRepository(db.db);
+    const fifoService = new SqliteFifoService(db.db);
 
     const useCase = new CreateSaleUseCase(
       saleRepo,
@@ -141,7 +147,8 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
       inventoryRepo,
       accountingRepo,
       customerLedgerRepo,
-      auditRepo
+      auditRepo,
+      fifoService
     );
 
     const availableProduct =
@@ -235,6 +242,7 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
       const accountingRepo = new SqliteAccountingRepository(db.db);
       const customerLedgerRepo = new SqliteCustomerLedgerRepository(db.db);
       const auditRepo = new SqliteAuditRepository(db.db);
+      const fifoService = new SqliteFifoService(db.db);
 
       const useCase = new CreateSaleUseCase(
         saleRepo,
@@ -245,14 +253,16 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
         inventoryRepo,
         accountingRepo,
         customerLedgerRepo,
-        auditRepo
+        auditRepo,
+        fifoService
       );
 
       const availableProduct =
         productRepo
           .findAll({ limit: 50 })
-          .items.find((item) => Boolean(item.id) && (item.stock || 0) > 0 && (item.sellingPrice || 0) > 0) ||
-        null;
+          .items.find(
+            (item) => Boolean(item.id) && (item.stock || 0) > 0 && (item.sellingPrice || 0) > 0
+          ) || null;
 
       if (!availableProduct?.id) {
         return ok({
@@ -341,6 +351,7 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
       const supplierLedgerRepo = new SqliteSupplierLedgerRepository(db.db);
       const accountingRepo = new SqliteAccountingRepository(db.db);
       const settingsRepo = new SqliteSettingsRepository(db.db);
+      const auditRepo2 = new SqliteAuditRepository(db.db);
 
       const purchaseUseCase = new CreatePurchaseUseCase(
         purchaseRepo,
@@ -348,10 +359,12 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
         paymentRepo,
         supplierLedgerRepo,
         accountingRepo,
-        settingsRepo
+        settingsRepo,
+        auditRepo2
       );
 
-      const existingSupplier = (await supplierRepo.findAll({ limit: 1, offset: 0 })).items[0] || null;
+      const existingSupplier =
+        (await supplierRepo.findAll({ limit: 1, offset: 0 })).items[0] || null;
       const supplier: Supplier =
         existingSupplier ||
         (await supplierRepo.create({
@@ -415,7 +428,9 @@ export function registerDiagnosticsHandlers(db: DatabaseType) {
         idempotencyKey: `diag-purchase-${Date.now()}`,
       };
 
-      const result = withTransaction(db.sqlite, () => purchaseUseCase.executeCommitPhase(purchaseInput, 1));
+      const result = withTransaction(db.sqlite, () =>
+        purchaseUseCase.executeCommitPhase(purchaseInput, 1)
+      );
 
       return ok({
         ok: true,
diff --git a/apps/electron/src/ipc/ProductHandler.ts b/apps/electron/src/ipc/ProductHandler.ts
index 72de528..923ee6a 100644
--- a/apps/electron/src/ipc/ProductHandler.ts
+++ b/apps/electron/src/ipc/ProductHandler.ts
@@ -11,6 +11,7 @@ import {
   SqliteProductWorkspaceRepository,
   SqliteInventoryRepository,
   SqliteAccountingRepository,
+  SqliteAuditRepository,
   withTransaction,
   DatabaseType,
 } from '@nuqtaplus/data';
@@ -24,14 +25,16 @@ export function registerProductHandlers(db: DatabaseType) {
   const productWorkspaceRepo = new SqliteProductWorkspaceRepository(db.db);
   const inventoryRepo = new SqliteInventoryRepository(db.db);
   const accountingRepo = new SqliteAccountingRepository(db.db);
+  const auditRepo = new SqliteAuditRepository(db.db);
   const getProductsUseCase = new GetProductsUseCase(productRepo);
-  const createProductUseCase = new CreateProductUseCase(productRepo);
-  const updateProductUseCase = new UpdateProductUseCase(productRepo);
-  const deleteProductUseCase = new DeleteProductUseCase(productRepo);
+  const createProductUseCase = new CreateProductUseCase(productRepo, auditRepo);
+  const updateProductUseCase = new UpdateProductUseCase(productRepo, auditRepo);
+  const deleteProductUseCase = new DeleteProductUseCase(productRepo, auditRepo);
   const adjustStockUseCase = new AdjustProductStockUseCase(
     productRepo,
     inventoryRepo,
-    accountingRepo
+    accountingRepo,
+    auditRepo
   );
 
   /**
@@ -47,11 +50,7 @@ export function registerProductHandlers(db: DatabaseType) {
     }
 
     // Validate optional SKU
-    if (
-      data.sku !== undefined &&
-      data.sku !== null &&
-      typeof data.sku !== 'string'
-    ) {
+    if (data.sku !== undefined && data.sku !== null && typeof data.sku !== 'string') {
       throw buildValidationError(channel, payload, 'SKU must be a string if provided');
     }
 
@@ -154,7 +153,8 @@ export function registerProductHandlers(db: DatabaseType) {
       requirePermission({ permission: 'products:read' });
 
       const { params } = assertPayload('products:getAll', payload, ['params']);
-      const parsed = params && typeof params === 'object' ? (params as Record<string, unknown>) : {};
+      const parsed =
+        params && typeof params === 'object' ? (params as Record<string, unknown>) : {};
       const result = await getProductsUseCase.execute({
         search: typeof parsed.search === 'string' ? parsed.search : undefined,
         page: typeof parsed.page === 'number' ? parsed.page : Number(parsed.page) || 1,
@@ -202,10 +202,8 @@ export function registerProductHandlers(db: DatabaseType) {
       }
 
       const result = productWorkspaceRepo.findPurchaseHistoryByProduct(productId, {
-        limit:
-          typeof params.limit === 'number' ? params.limit : Number(params.limit) || 50,
-        offset:
-          typeof params.offset === 'number' ? params.offset : Number(params.offset) || 0,
+        limit: typeof params.limit === 'number' ? params.limit : Number(params.limit) || 50,
+        offset: typeof params.offset === 'number' ? params.offset : Number(params.offset) || 0,
       });
 
       return ok(result);
@@ -234,10 +232,8 @@ export function registerProductHandlers(db: DatabaseType) {
       }
 
       const result = productWorkspaceRepo.findSalesHistoryByProduct(productId, {
-        limit:
-          typeof params.limit === 'number' ? params.limit : Number(params.limit) || 50,
-        offset:
-          typeof params.offset === 'number' ? params.offset : Number(params.offset) || 0,
+        limit: typeof params.limit === 'number' ? params.limit : Number(params.limit) || 50,
+        offset: typeof params.offset === 'number' ? params.offset : Number(params.offset) || 0,
       });
 
       return ok(result);
diff --git a/apps/electron/src/ipc/PurchaseHandler.ts b/apps/electron/src/ipc/PurchaseHandler.ts
index 93cead2..ee908b8 100644
--- a/apps/electron/src/ipc/PurchaseHandler.ts
+++ b/apps/electron/src/ipc/PurchaseHandler.ts
@@ -3,6 +3,7 @@ import {
   CreatePurchaseUseCase,
   GetPurchasesUseCase,
   GetPurchaseByIdUseCase,
+  AddPurchasePaymentUseCase,
 } from '@nuqtaplus/core';
 import {
   SqlitePurchaseRepository,
@@ -11,6 +12,7 @@ import {
   SqliteSupplierLedgerRepository,
   SqliteAccountingRepository,
   SqliteSettingsRepository,
+  SqliteAuditRepository,
   withTransaction,
   DatabaseType,
 } from '@nuqtaplus/data';
@@ -25,6 +27,7 @@ export function registerPurchaseHandlers(db: DatabaseType) {
   const supplierLedgerRepo = new SqliteSupplierLedgerRepository(db.db);
   const accountingRepo = new SqliteAccountingRepository(db.db);
   const settingsRepo = new SqliteSettingsRepository(db.db);
+  const auditRepo = new SqliteAuditRepository(db.db);
 
   const createUseCase = new CreatePurchaseUseCase(
     purchaseRepo,
@@ -32,6 +35,14 @@ export function registerPurchaseHandlers(db: DatabaseType) {
     paymentRepo,
     supplierLedgerRepo,
     accountingRepo,
+    settingsRepo,
+    auditRepo
+  );
+  const addPaymentUseCase = new AddPurchasePaymentUseCase(
+    purchaseRepo,
+    paymentRepo,
+    supplierLedgerRepo,
+    accountingRepo,
     settingsRepo
   );
   const getAllUseCase = new GetPurchasesUseCase(purchaseRepo);
@@ -45,7 +56,9 @@ export function registerPurchaseHandlers(db: DatabaseType) {
       }
 
       const userId = userContextService.getUserId() || 1;
-      const result = withTransaction(db.sqlite, () => createUseCase.executeCommitPhase(data as any, userId));
+      const result = withTransaction(db.sqlite, () =>
+        createUseCase.executeCommitPhase(data as any, userId)
+      );
 
       return ok(result.createdPurchase);
     } catch (error: unknown) {
@@ -76,4 +89,26 @@ export function registerPurchaseHandlers(db: DatabaseType) {
       return mapErrorToIpcResponse(error);
     }
   });
+
+  /**
+   * Add payment to a purchase invoice.
+   * Wraps in transaction: payment record + supplier ledger + journal entry.
+   */
+  ipcMain.handle('purchases:addPayment', async (_, payload) => {
+    try {
+      const { data } = assertPayload('purchases:addPayment', payload, ['data']);
+      if (!data || typeof data !== 'object' || Array.isArray(data)) {
+        throw buildValidationError('purchases:addPayment', payload, 'data must be an object');
+      }
+
+      const userId = userContextService.getUserId() || 1;
+      const result = withTransaction(db.sqlite, () =>
+        addPaymentUseCase.executeCommitPhase(data as any, userId)
+      );
+
+      return ok(result.updatedPurchase);
+    } catch (error: unknown) {
+      return mapErrorToIpcResponse(error);
+    }
+  });
 }
diff --git a/apps/electron/src/ipc/SaleHandler.ts b/apps/electron/src/ipc/SaleHandler.ts
index 5ba8ba3..b12b5dd 100644
--- a/apps/electron/src/ipc/SaleHandler.ts
+++ b/apps/electron/src/ipc/SaleHandler.ts
@@ -10,6 +10,7 @@ import {
   SqliteInventoryRepository,
   SqliteAccountingRepository,
   SqliteCustomerLedgerRepository,
+  SqliteFifoService,
   withTransaction,
   DatabaseType,
 } from '@nuqtaplus/data';
@@ -28,6 +29,7 @@ export function registerSaleHandlers(db: DatabaseType) {
   const inventoryRepo = new SqliteInventoryRepository(db.db);
   const accountingRepo = new SqliteAccountingRepository(db.db);
   const customerLedgerRepo = new SqliteCustomerLedgerRepository(db.db);
+  const fifoService = new SqliteFifoService(db.db);
 
   const createSaleUseCase = new CreateSaleUseCase(
     saleRepo,
@@ -38,7 +40,8 @@ export function registerSaleHandlers(db: DatabaseType) {
     inventoryRepo,
     accountingRepo,
     customerLedgerRepo,
-    auditRepo
+    auditRepo,
+    fifoService
   );
 
   const addPaymentUseCase = new AddPaymentUseCase(
diff --git a/apps/electron/src/main/index.ts b/apps/electron/src/main/index.ts
index 9f03fa2..3fac77c 100644
--- a/apps/electron/src/main/index.ts
+++ b/apps/electron/src/main/index.ts
@@ -4,7 +4,6 @@ import { createDb } from '@nuqtaplus/data';
 import { registerProductHandlers } from '../ipc/ProductHandler';
 import { registerSaleHandlers } from '../ipc/SaleHandler';
 import { registerAuthHandlers } from '../ipc/AuthHandler';
-import { registerDashboardHandlers } from '../ipc/DashboardHandler';
 import { registerCustomerHandlers } from '../ipc/CustomerHandler';
 import { registerCategoryHandlers } from '../ipc/CategoryHandler';
 import { registerUserHandlers } from '../ipc/UserHandler';
@@ -22,6 +21,8 @@ import { registerBarcodeHandlers } from '../ipc/BarcodeHandler';
 import { registerAccountingHandlers } from '../ipc/AccountingHandler';
 import { registerSupplierLedgerHandlers } from '../ipc/SupplierLedgerHandler';
 import { registerDiagnosticsHandlers } from '../ipc/DiagnosticsHandler';
+import { registerSetupWizardHandlers } from '../ipc/SetupWizardHandler';
+import { registerPostingHandlers } from '../ipc/PostingHandler';
 import { UpdateService } from '../services/UpdateService.js';
 import { applyMigrations } from '../services/MigrationService.js';
 
@@ -149,7 +150,6 @@ app.whenReady().then(() => {
   registerProductHandlers(db);
   registerSaleHandlers(db);
   registerAuthHandlers(db);
-  registerDashboardHandlers(db);
   registerCustomerHandlers(db);
   registerCategoryHandlers(db);
   registerUserHandlers(db);
@@ -166,6 +166,8 @@ app.whenReady().then(() => {
   registerBarcodeHandlers(db);
   registerAccountingHandlers(db);
   registerSupplierLedgerHandlers(db);
+  registerSetupWizardHandlers(db);
+  registerPostingHandlers(db);
   if (isDev) registerDiagnosticsHandlers(db);
 
   // Initialize auto-update
diff --git a/apps/electron/src/preload/index.ts b/apps/electron/src/preload/index.ts
index 8816c44..b5514ad 100644
--- a/apps/electron/src/preload/index.ts
+++ b/apps/electron/src/preload/index.ts
@@ -51,9 +51,6 @@ const ALLOWED_CHANNELS = new Set([
   'setup:seedChartOfAccounts',
   'setup:getAccountingSetupStatus',
 
-  // Dashboard
-  'dashboard:getStats',
-
   // Customers
   'customers:getAll',
   'customers:getById',
@@ -118,6 +115,7 @@ const ALLOWED_CHANNELS = new Set([
   'purchases:getAll',
   'purchases:getById',
   'purchases:create',
+  'purchases:addPayment',
 
   // Inventory
   'inventory:getMovements',
@@ -151,6 +149,17 @@ const ALLOWED_CHANNELS = new Set([
   'supplierLedger:recordPayment',
   'supplierLedger:reconcileBalance',
 
+  // Setup Wizard — Module Settings
+  'settings:getModules',
+  'settings:completeWizard',
+  'settings:setModuleToggle',
+
+  // Posting Batches
+  'posting:postPeriod',
+  'posting:getBatches',
+  'posting:reverseEntry',
+  'posting:reverseBatch',
+
   // Diagnostics — DEV ONLY (not exposed in production preload)
 ]);
 
diff --git a/apps/ui/src/app/router/index.ts b/apps/ui/src/app/router/index.ts
index 37230d5..36872d2 100644
--- a/apps/ui/src/app/router/index.ts
+++ b/apps/ui/src/app/router/index.ts
@@ -16,6 +16,7 @@ declare module 'vue-router' {
     requiresAccounting?: boolean;
     requiresPurchasing?: boolean;
     requiresLedgers?: boolean;
+    requiresPaymentsOnInvoices?: boolean;
     enableBarcode?: 'pos' | 'product';
   }
 }
diff --git a/apps/ui/src/app/router/routes.ts b/apps/ui/src/app/router/routes.ts
index be38592..57f3095 100644
--- a/apps/ui/src/app/router/routes.ts
+++ b/apps/ui/src/app/router/routes.ts
@@ -1,7 +1,6 @@
 ﻿import type { RouteRecordRaw } from 'vue-router';
 import PosLayout from '../../layouts/PosLayout.vue';
 import AuthLayout from '../../layouts/AuthLayout.vue';
-import DashboardView from '../../views/dashboard/DashboardView.vue';
 import PosView from '../../views/pos/PosView.vue';
 import ForbiddenView from '../../views/system/ForbiddenView.vue';
 import NotFoundView from '../../views/system/NotFoundView.vue';
@@ -43,11 +42,6 @@ export const routes: RouteRecordRaw[] = [
         meta: { enableBarcode: 'pos' },
       },
       ...simpleModeRoutes,
-      {
-        path: 'dashboard',
-        name: 'Dashboard',
-        component: DashboardView,
-      },
       ...customersRoutes,
       ...productsRoutes,
       ...salesRoutes,
diff --git a/apps/ui/src/auth/guards.ts b/apps/ui/src/auth/guards.ts
index 930218a..12923fb 100644
--- a/apps/ui/src/auth/guards.ts
+++ b/apps/ui/src/auth/guards.ts
@@ -8,11 +8,6 @@ export function applyAuthGuard(router: Router): void {
     const authStore = useAuthStore();
     const featureFlagsStore = useFeatureFlagsStore();
 
-    // Allow the setup page itself without any checks
-    if (to.name === 'InitialSetup') {
-      return true;
-    }
-
     // Lazy-load setup status if not yet fetched
     if (!authStore.setupStatus) {
       try {
@@ -23,8 +18,16 @@ export function applyAuthGuard(router: Router): void {
       }
     }
 
-    // If app is NOT initialized, redirect to setup wizard
-    if (authStore.setupStatus && !authStore.isInitialized) {
+    if (to.name === 'InitialSetup') {
+      if (authStore.setupStatus?.isInitialized && authStore.isSetupWizardCompleted) {
+        const isAuth = await authStore.ensureAuthenticated();
+        return isAuth ? { path: '/' } : { name: 'Login' };
+      }
+      return true;
+    }
+
+    // Block app until initial setup wizard is completed.
+    if (authStore.setupStatus && (!authStore.isInitialized || !authStore.isSetupWizardCompleted)) {
       return { name: 'InitialSetup' };
     }
 
@@ -46,44 +49,39 @@ export function applyAuthGuard(router: Router): void {
       authStore.startSessionCheck();
       await featureFlagsStore.hydrate();
 
-      if (featureFlagsStore.simpleMode && to.name === 'POS') {
-        return { name: 'SimpleSales' };
-      }
-      if (!featureFlagsStore.simpleMode && to.name === 'SimpleSales') {
-        return { name: 'POS' };
-      }
-      if (!featureFlagsStore.simpleMode && to.name === 'SimpleProductCreate') {
-        return { name: 'ProductWorkspace' };
-      }
-
       const role = authStore.user?.role;
       if (!role) {
         return { name: 'Forbidden' };
       }
 
       if (to.meta.requiresAccounting && !featureFlagsStore.accountingEnabled) {
-        const routeName = String(to.name || '');
-        const fallbackName = routeName.startsWith('Product') ? 'SimpleProductCreate' : 'SimpleSales';
         return {
-          name: fallbackName,
+          name: 'Dashboard',
           query: { blocked: 'accounting_disabled', redirect: to.fullPath },
         };
       }
 
-      if (to.meta.requiresPurchasing && !featureFlagsStore.accountingEnabled) {
+      if (to.meta.requiresPurchasing && !featureFlagsStore.purchasesEnabled) {
         return {
-          name: 'SimpleSales',
+          name: 'Dashboard',
           query: { blocked: 'purchasing_disabled', redirect: to.fullPath },
         };
       }
 
-      if (to.meta.requiresLedgers && !featureFlagsStore.accountingEnabled) {
+      if (to.meta.requiresLedgers && !featureFlagsStore.ledgersEnabled) {
         return {
-          name: 'SimpleSales',
+          name: 'Dashboard',
           query: { blocked: 'ledgers_disabled', redirect: to.fullPath },
         };
       }
 
+      if (to.meta.requiresPaymentsOnInvoices && !featureFlagsStore.paymentsOnInvoicesEnabled) {
+        return {
+          name: 'Dashboard',
+          query: { blocked: 'invoice_payments_disabled', redirect: to.fullPath },
+        };
+      }
+
       if (to.meta.requiresManageProducts && !uiAccess.canManageProducts(role)) {
         return { name: 'Forbidden' };
       }
diff --git a/apps/ui/src/components/pos/CartPanel.vue b/apps/ui/src/components/pos/CartPanel.vue
index 460a88f..377e5e1 100644
--- a/apps/ui/src/components/pos/CartPanel.vue
+++ b/apps/ui/src/components/pos/CartPanel.vue
@@ -197,13 +197,13 @@ const formatPrice = (price: number) => {
     style: 'currency',
     currency: 'IQD',
     minimumFractionDigits: 0,
-    maximumFractionDigits: 2,
+    maximumFractionDigits: 0,
     numberingSystem: 'latn',
   }).format(price);
 };
 
 const itemSubtotal = (item: SaleItem) => {
-  return Math.max(0, item.quantity * item.unitPrice - (item.discount || 0));
+  return Math.max(0, Math.round(item.quantity * item.unitPrice - (item.discount || 0)));
 };
 
 const drawerWidth = computed(() => layout.drawerWidth);
diff --git a/apps/ui/src/components/pos/PaymentOverlay.vue b/apps/ui/src/components/pos/PaymentOverlay.vue
index ae473ec..e572048 100644
--- a/apps/ui/src/components/pos/PaymentOverlay.vue
+++ b/apps/ui/src/components/pos/PaymentOverlay.vue
@@ -324,7 +324,7 @@ const keypadKeys = [
   { id: '7', label: '7' },
   { id: '8', label: '8' },
   { id: '9', label: '9' },
-  { id: '.', label: '.' },
+  { id: '00', label: '00' },
   { id: '0', label: '0' },
   { id: 'backspace', label: '⌫' },
 ];
@@ -473,30 +473,22 @@ function formatCurrency(value: number): string {
     }).format(value);
   } catch {
     return new Intl.NumberFormat('ar-IQ', {
-      minimumFractionDigits: 2,
-      maximumFractionDigits: 2,
+      minimumFractionDigits: 0,
+      maximumFractionDigits: 0,
       numberingSystem: 'latn',
-    }).format(value);
+    }).format(Math.round(value));
   }
 }
 
 function normalizeDecimalInput(value: string): string {
-  let normalized = value.replace(/[^\d.]/g, '');
-
-  const dotIndex = normalized.indexOf('.');
-  if (dotIndex >= 0) {
-    const integerPart = normalized.slice(0, dotIndex);
-    const decimalPart = normalized.slice(dotIndex + 1).replace(/\./g, '');
-    normalized = `${integerPart}.${decimalPart}`;
-  }
-
-  return Math.max(0, parseFloat(normalized) || 0).toString();
+  const normalized = value.replace(/[^\d]/g, '');
+  const parsed = parseInt(normalized, 10);
+  return (Number.isFinite(parsed) ? Math.max(0, parsed) : 0).toString();
 }
 
 function toInputAmount(value: number): string {
   if (!Number.isFinite(value) || value <= 0) return '';
-  if (Number.isInteger(value)) return String(value);
-  return value.toFixed(2).replace(/\.?0+$/, '');
+  return String(Math.round(value));
 }
 
 const isRewriteMode = ref(true); // first keypad press overwrites existing value
@@ -515,7 +507,7 @@ function onExtraDiscountInput(value: string) {
 
 function appendAmount(char: string) {
   if (props.busy) return;
-  if (!/^\d$/.test(char) && char !== '.') return;
+  if (!/^\d$/.test(char) && char !== '00') return;
 
   // Rewrite behavior: first keypad press clears and starts fresh
   if (isRewriteMode.value) {
@@ -526,11 +518,13 @@ function appendAmount(char: string) {
 
   const current = amountInput.value ?? '';
 
-  // Dot key: switch to decimal mode (only once)
-  if (char === '.') {
-    if (current.includes('.')) return;
-    amountInput.value = current === '' ? '0.' : current + '.';
-    entryMode.value = 'dec';
+  // '00' key: append two zeros
+  if (char === '00') {
+    if (current === '' || current === '0') {
+      amountInput.value = '0';
+      return;
+    }
+    amountInput.value = current + '00';
     return;
   }
 
diff --git a/apps/ui/src/components/pos/ProductTile.vue b/apps/ui/src/components/pos/ProductTile.vue
index ed994e4..6640270 100644
--- a/apps/ui/src/components/pos/ProductTile.vue
+++ b/apps/ui/src/components/pos/ProductTile.vue
@@ -67,7 +67,7 @@ const formatPrice = (price: number) => {
     style: 'currency',
     currency: 'IQD',
     minimumFractionDigits: 0,
-    maximumFractionDigits: 4,
+    maximumFractionDigits: 0,
     numberingSystem: 'latn',
   }).format(price);
 };
diff --git a/apps/ui/src/components/pos/TotalsPanel.vue b/apps/ui/src/components/pos/TotalsPanel.vue
index 950cdf7..ae8c75b 100644
--- a/apps/ui/src/components/pos/TotalsPanel.vue
+++ b/apps/ui/src/components/pos/TotalsPanel.vue
@@ -70,7 +70,7 @@ const formatPrice = (price: number) => {
     style: 'currency',
     currency: 'IQD',
     minimumFractionDigits: 0,
-    maximumFractionDigits: 4,
+    maximumFractionDigits: 0,
     numberingSystem: 'latn',
   }).format(price);
 };
diff --git a/apps/ui/src/components/pos/safeParseAmount.ts b/apps/ui/src/components/pos/safeParseAmount.ts
index 9aad7f9..562bd68 100644
--- a/apps/ui/src/components/pos/safeParseAmount.ts
+++ b/apps/ui/src/components/pos/safeParseAmount.ts
@@ -1,6 +1,6 @@
 export function safeParseAmount(input: string | number | null | undefined): number {
   if (typeof input === 'number') {
-    return Number.isFinite(input) ? Math.max(0, input) : 0;
+    return Number.isFinite(input) ? Math.max(0, Math.round(input)) : 0;
   }
 
   if (typeof input !== 'string') {
@@ -19,5 +19,5 @@ export function safeParseAmount(input: string | number | null | undefined): numb
     return 0;
   }
 
-  return Math.max(0, parsed);
+  return Math.max(0, Math.round(parsed));
 }
diff --git a/apps/ui/src/components/shared/JournalEntryViewer.vue b/apps/ui/src/components/shared/JournalEntryViewer.vue
index 0a4aeed..0c04491 100644
--- a/apps/ui/src/components/shared/JournalEntryViewer.vue
+++ b/apps/ui/src/components/shared/JournalEntryViewer.vue
@@ -47,7 +47,7 @@
         </tr>
       </tbody>
       <tfoot>
-        <tr class="font-weight-bold">
+        <tr class="font-weight-bold" :class="{ 'bg-error-lighten-5': isImbalanced }">
           <td>المجموع</td>
           <td
             class="text-end"
@@ -68,6 +68,18 @@
     <v-card-text v-if="entry.notes" class="text-caption text-medium-emphasis pt-2">
       {{ entry.notes }}
     </v-card-text>
+
+    <!-- Imbalance warning -->
+    <v-alert
+      v-if="isImbalanced"
+      type="error"
+      variant="tonal"
+      density="compact"
+      class="ma-3"
+      prepend-icon="mdi-alert-circle"
+    >
+      القيد غير متوازن — الفرق: {{ Math.abs(totalDebit - totalCredit).toLocaleString('en-US') }}
+    </v-alert>
   </v-card>
 </template>
 
@@ -112,6 +124,8 @@ const totalDebit = computed(() =>
 const totalCredit = computed(() =>
   (props.entry.lines ?? []).reduce((sum, l) => sum + (l.credit || 0), 0)
 );
+
+const isImbalanced = computed(() => Math.abs(totalDebit.value - totalCredit.value) > 0);
 </script>
 
 <style scoped>
diff --git a/apps/ui/src/components/shared/MoneyDisplay.vue b/apps/ui/src/components/shared/MoneyDisplay.vue
index 46ca9f8..5884155 100644
--- a/apps/ui/src/components/shared/MoneyDisplay.vue
+++ b/apps/ui/src/components/shared/MoneyDisplay.vue
@@ -22,7 +22,7 @@ const props = withDefaults(
 );
 
 const formatted = computed(() => {
-  const val = props.amount ?? 0;
+  const val = Math.round(props.amount ?? 0);
   const num = val.toLocaleString('en-US');
   return props.currency === 'IQD' ? `${num} د.ع` : `${num} ${props.currency}`;
 });
diff --git a/apps/ui/src/composables/useCurrency.ts b/apps/ui/src/composables/useCurrency.ts
index b44c591..60c0f7d 100644
--- a/apps/ui/src/composables/useCurrency.ts
+++ b/apps/ui/src/composables/useCurrency.ts
@@ -59,7 +59,7 @@ export function useCurrency() {
     amount: number,
     options?: { showSymbol?: boolean; decimals?: number }
   ): string => {
-    const { showSymbol = true, decimals = 2 } = options || {};
+    const { showSymbol = true, decimals = 0 } = options || {};
     const formatted = amount.toLocaleString('en-US', {
       minimumFractionDigits: decimals,
       maximumFractionDigits: decimals,
diff --git a/apps/ui/src/ipc/authClient.ts b/apps/ui/src/ipc/authClient.ts
index 706b4c6..87961c0 100644
--- a/apps/ui/src/ipc/authClient.ts
+++ b/apps/ui/src/ipc/authClient.ts
@@ -20,6 +20,7 @@ export interface AuthSetupStatus {
   isInitialized: boolean;
   hasUsers: boolean;
   hasCompanyInfo: boolean;
+  wizardCompleted: boolean;
 }
 
 export interface InitializeAppRequest {
diff --git a/apps/ui/src/ipc/barcodeClient.ts b/apps/ui/src/ipc/barcodeClient.ts
index 4967e7c..53973cb 100644
--- a/apps/ui/src/ipc/barcodeClient.ts
+++ b/apps/ui/src/ipc/barcodeClient.ts
@@ -14,7 +14,9 @@ export type BarcodeTemplateInput = Pick<
   | 'showBarcode'
   | 'showExpiry'
   | 'isDefault'
->;
+> & {
+  layoutJson?: string | null;
+};
 
 export interface PrintJobInput {
   templateId: number;
diff --git a/apps/ui/src/ipc/index.ts b/apps/ui/src/ipc/index.ts
index e2ec4d9..58a15bd 100644
--- a/apps/ui/src/ipc/index.ts
+++ b/apps/ui/src/ipc/index.ts
@@ -14,6 +14,8 @@ export { accountingClient } from './accountingClient';
 export { customerLedgerClient } from './customerLedgerClient';
 export { supplierLedgerClient } from './supplierLedgerClient';
 export { barcodeClient } from './barcodeClient';
+export { postingClient } from './postingClient';
+export { auditClient } from './auditClient';
 export { setupClient } from './setupClient';
 export { registerUnauthorizedHandler } from './errorInterceptor';
 export type { ApiResult, ApiError, PagedResult } from './contracts';
diff --git a/apps/ui/src/ipc/purchasesClient.ts b/apps/ui/src/ipc/purchasesClient.ts
index c8a1981..1d12149 100644
--- a/apps/ui/src/ipc/purchasesClient.ts
+++ b/apps/ui/src/ipc/purchasesClient.ts
@@ -24,6 +24,19 @@ export interface PurchaseCreateInput {
   idempotencyKey?: string;
 }
 
+export interface PurchasePaymentInput {
+  purchaseId: number;
+  supplierId?: number;
+  amount: number;
+  paymentMethod: 'cash' | 'card' | 'bank_transfer' | 'credit' | string;
+  referenceNumber?: string;
+  paymentDate?: string;
+  notes?: string;
+  currency?: string;
+  exchangeRate?: number;
+  idempotencyKey?: string;
+}
+
 export const purchasesClient = {
   getAll: (params?: {
     search?: string;
@@ -42,4 +55,9 @@ export const purchasesClient = {
       'purchases:create',
       buildDataPayload('purchases:create', data as unknown as Record<string, unknown>)
     ),
+  addPayment: (data: PurchasePaymentInput): Promise<ApiResult<Purchase>> =>
+    invoke<Purchase>(
+      'purchases:addPayment',
+      buildDataPayload('purchases:addPayment', data as unknown as Record<string, unknown>)
+    ),
 };
diff --git a/apps/ui/src/ipc/settingsClient.ts b/apps/ui/src/ipc/settingsClient.ts
index 9837974..458a0ef 100644
--- a/apps/ui/src/ipc/settingsClient.ts
+++ b/apps/ui/src/ipc/settingsClient.ts
@@ -3,6 +3,48 @@ import type { SettingsCurrencyResponse, CompanySettings } from '../types/domain'
 import { invoke } from './invoke';
 import { buildDataPayload, buildKeyPayload } from './payloads';
 
+/**
+ * Module settings types for the setup wizard and gating
+ */
+export interface ModuleSettings {
+  accountingEnabled: boolean;
+  purchasesEnabled: boolean;
+  ledgersEnabled: boolean;
+  unitsEnabled: boolean;
+  paymentsOnInvoicesEnabled: boolean;
+}
+
+export interface NotificationSettings {
+  lowStockThreshold: number;
+  expiryDays: number;
+  debtReminderCount: number;
+  debtReminderIntervalDays: number;
+}
+
+export interface InvoiceSettings {
+  templateActiveId: string;
+  prefix: string;
+  paperSize: 'thermal' | 'a4' | 'a5';
+  logo: string;
+  footerNotes: string;
+  layoutDirection: 'rtl' | 'ltr';
+  showQr: boolean;
+  showBarcode: boolean;
+}
+
+export interface AllModuleSettings {
+  modules: ModuleSettings;
+  notifications: NotificationSettings;
+  invoice: InvoiceSettings;
+  wizardCompleted: boolean;
+}
+
+export interface SetupWizardPayload {
+  modules: ModuleSettings;
+  notifications: NotificationSettings;
+  invoice: InvoiceSettings;
+}
+
 export const settingsClient = {
   get: (key: string): Promise<ApiResult<string | null>> =>
     invoke<string | null>('settings:get', buildKeyPayload('settings:get', key)),
@@ -24,4 +66,24 @@ export const settingsClient = {
 
   getPrinters: (): Promise<ApiResult<{ printers: string[] }>> =>
     invoke<{ printers: string[] }>('printers:getAll'),
+
+  // ── Module Settings (Setup Wizard + Gating) ──
+
+  /** Get all module toggle settings */
+  getModules: (): Promise<ApiResult<AllModuleSettings>> =>
+    invoke<AllModuleSettings>('settings:getModules'),
+
+  /** Complete the setup wizard (writes all settings atomically) */
+  completeWizard: (data: SetupWizardPayload): Promise<ApiResult<AllModuleSettings>> =>
+    invoke<AllModuleSettings>(
+      'settings:completeWizard',
+      buildDataPayload('settings:completeWizard', data as any)
+    ),
+
+  /** Toggle a single module setting */
+  setModuleToggle: (key: string, value: boolean): Promise<ApiResult<AllModuleSettings>> =>
+    invoke<AllModuleSettings>(
+      'settings:setModuleToggle',
+      buildDataPayload('settings:setModuleToggle', { key, value })
+    ),
 };
diff --git a/apps/ui/src/layouts/MainLayout.vue b/apps/ui/src/layouts/MainLayout.vue
index f65de75..1af4d65 100644
--- a/apps/ui/src/layouts/MainLayout.vue
+++ b/apps/ui/src/layouts/MainLayout.vue
@@ -50,13 +50,6 @@
             :title="t('nav.categories')"
             class="mb-1"
           />
-          <v-list-item
-            exact
-            to="/users"
-            prepend-icon="mdi-account-multiple-outline"
-            :title="t('nav.users')"
-            class="mb-1"
-          />
           <v-list-item
             exact
             to="/settings"
diff --git a/apps/ui/src/layouts/PosLayout.vue b/apps/ui/src/layouts/PosLayout.vue
index 3fddfd2..b5b17da 100644
--- a/apps/ui/src/layouts/PosLayout.vue
+++ b/apps/ui/src/layouts/PosLayout.vue
@@ -143,13 +143,13 @@ const primaryNav = computed(() => {
 
   return [
     {
-      to: featureFlagsStore.simpleMode ? '/simple/sales' : '/pos',
+      to: '/pos',
       icon: 'mdi-point-of-sale',
       label: t('nav.pos'),
       visible: uiAccess.canCreateSales(role),
     },
     {
-      to: featureFlagsStore.simpleMode ? '/simple/products' : '/products',
+      to: '/products',
       icon: 'mdi-package-variant',
       label: t('nav.products'),
       visible: uiAccess.canManageProducts(role),
@@ -170,13 +170,13 @@ const primaryNav = computed(() => {
       to: '/purchases',
       icon: 'mdi-cart-arrow-down',
       label: t('nav.purchases'),
-      visible: uiAccess.canManagePurchases(role) && !featureFlagsStore.simpleMode,
+      visible: uiAccess.canManagePurchases(role) && featureFlagsStore.purchasesEnabled,
     },
     {
       to: '/suppliers',
       icon: 'mdi-truck-delivery',
       label: t('nav.suppliers'),
-      visible: uiAccess.canManageSuppliers(role) && !featureFlagsStore.simpleMode,
+      visible: uiAccess.canManageSuppliers(role) && featureFlagsStore.purchasesEnabled,
     },
     {
       to: '/sales',
@@ -190,14 +190,13 @@ const primaryNav = computed(() => {
       label: t('nav.customers'),
       visible: uiAccess.canManageCustomers(role),
     },
-
     {
-      to: '/users',
-      icon: 'mdi-account-multiple-outline',
-      label: t('nav.users'),
-      visible: uiAccess.canManageUsers(role),
+      to: '/invoice-payments',
+      icon: 'mdi-cash-multiple',
+      label: 'دفعات الفواتير',
+      visible: featureFlagsStore.ledgersEnabled && featureFlagsStore.paymentsOnInvoicesEnabled,
     },
-    { to: '/dashboard', icon: 'mdi-chart-box', label: t('nav.dashboard'), visible: true },
+
   ].filter((item) => item.visible);
 });
 
@@ -247,6 +246,8 @@ watch(
       featureNoticeText.value = 'المشتريات والموردون غير متاحين في الوضع البسيط.';
     } else if (blocked === 'ledgers_disabled') {
       featureNoticeText.value = 'دفاتر العملاء/الموردين غير متاحة في الوضع البسيط.';
+    } else if (blocked === 'invoice_payments_disabled') {
+      featureNoticeText.value = 'دفعات الفواتير غير مفعلة في إعدادات النظام.';
     } else {
       featureNoticeText.value = 'هذه الصفحة غير متاحة في الوضع الحالي.';
     }
diff --git a/apps/ui/src/modules/accounting/routes.ts b/apps/ui/src/modules/accounting/routes.ts
index 7a4af11..87ecf8a 100644
--- a/apps/ui/src/modules/accounting/routes.ts
+++ b/apps/ui/src/modules/accounting/routes.ts
@@ -1,4 +1,6 @@
 import type { RouteRecordRaw } from 'vue-router';
+import PostingView from '../../views/accounting/PostingView.vue';
+import InvoicePaymentsView from '../../views/accounting/InvoicePaymentsView.vue';
 
 export const accountingRoutes: RouteRecordRaw[] = [
   {
@@ -60,4 +62,16 @@ export const accountingRoutes: RouteRecordRaw[] = [
       query: { ...to.query, section: 'accounting', accountingTab: 'balance' },
     }),
   },
+  {
+    path: 'accounting/posting',
+    name: 'Posting',
+    component: PostingView,
+    meta: { requiresAccounting: true },
+  },
+  {
+    path: 'invoice-payments',
+    name: 'InvoicePayments',
+    component: InvoicePaymentsView,
+    meta: { requiresLedgers: true, requiresPaymentsOnInvoices: true },
+  },
 ];
diff --git a/apps/ui/src/modules/dashboard/DashboardView.vue b/apps/ui/src/modules/dashboard/DashboardView.vue
deleted file mode 100644
index 8ab7cf1..0000000
--- a/apps/ui/src/modules/dashboard/DashboardView.vue
+++ /dev/null
@@ -1,177 +0,0 @@
-﻿<template>
-  <div class="win-page">
-    <v-app-bar class="ds-page-header d-flex align-center justify-space-between mb-6">
-      <v-app-bar-title>
-        <div class="win-title mb-0">{{ t('dashboard.title') }}</div>
-        <div class="text-sm">{{ t('dashboard.subtitle') }}</div>
-      </v-app-bar-title>
-    </v-app-bar>
-
-    <v-alert v-if="error" type="error" variant="tonal" class="mb-4">
-      {{ error }}
-    </v-alert>
-
-    <!-- Simple Metrics Grid -->
-    <v-row class="mb-6">
-      <v-col v-for="kpi in kpis" :key="kpi.label" cols="12" sm="6" md="3">
-        <v-card class="pa-4">
-          <div class="text-caption text-medium-emphasis mb-2">{{ kpi.label }}</div>
-          <div class="text-h5 font-weight-medium mb-1">{{ kpi.value }}</div>
-          <div class="d-flex align-center text-caption">
-            <v-icon
-              :icon="
-                kpi.trend === 'up'
-                  ? 'mdi-arrow-up'
-                  : kpi.trend === 'down'
-                    ? 'mdi-arrow-down'
-                    : 'mdi-minus'
-              "
-              :color="kpi.trend === 'up' ? 'success' : kpi.trend === 'down' ? 'error' : 'grey'"
-              size="16"
-              class="mr-1"
-            />
-            <span
-              :class="
-                kpi.trend === 'up'
-                  ? 'text-success'
-                  : kpi.trend === 'down'
-                    ? 'text-error'
-                    : 'text-grey'
-              "
-            >
-              {{ kpi.delta || t('dashboard.trend.neutral') }}
-            </span>
-          </div>
-        </v-card>
-      </v-col>
-    </v-row>
-
-    <!-- Analytics Table -->
-    <v-card class="mb-6">
-      <v-card-title class="text-subtitle-1 font-weight-medium py-3">
-        {{ t('dashboard.analytics') }}
-      </v-card-title>
-      <v-divider />
-      <v-card-text class="pa-0">
-        <v-data-table
-          :headers="analyticsHeaders"
-          :items="analyticsRows"
-          density="compact"
-          :hide-default-footer="true"
-        >
-          <template #item.value="{ item }">
-            <span class="text-right">{{ item.value }}</span>
-          </template>
-          <template #item.delta="{ item }">
-            <span :class="item.trendClass">
-              {{ item.delta }}
-            </span>
-          </template>
-        </v-data-table>
-      </v-card-text>
-    </v-card>
-
-    <!-- Simple Chart Placeholder -->
-    <v-card>
-      <v-card-title class="text-subtitle-1 font-weight-medium py-3">
-        {{ t('dashboard.salesVelocity') }}
-      </v-card-title>
-      <v-divider />
-      <v-card-text class="pa-8 text-center">
-        <v-icon size="48" color="grey-lighten-1">mdi-chart-line</v-icon>
-        <p class="text-body-2 text-medium-emphasis mt-2 mb-0">
-          {{ t('dashboard.chartPlaceholder') }}
-        </p>
-      </v-card-text>
-    </v-card>
-  </div>
-</template>
-
-<script setup lang="ts">
-import { computed, onMounted, onUnmounted } from 'vue';
-import { t } from '../../i18n/t';
-import { useDashboardMetrics } from './providers/useDashboardMetrics';
-
-const { metrics, loading, error, refresh } = useDashboardMetrics();
-let refreshTimer: number | null = null;
-
-const formatCount = (value: number): string => new Intl.NumberFormat('ar-IQ').format(value);
-const formatAmount = (value: number): string =>
-  new Intl.NumberFormat('ar-IQ', {
-    minimumFractionDigits: 2,
-    maximumFractionDigits: 2,
-  }).format(value);
-
-const kpis = computed(() => [
-  {
-    label: t('dashboard.totalSales'),
-    value: formatCount(metrics.value.totalSales.value),
-    trend: metrics.value.totalSales.trend ?? 'neutral',
-    delta: metrics.value.totalSales.delta,
-  },
-  {
-    label: t('dashboard.activeCustomers'),
-    value: formatCount(metrics.value.activeCustomers.value),
-    trend: metrics.value.activeCustomers.trend ?? 'neutral',
-    delta: metrics.value.activeCustomers.delta,
-  },
-  {
-    label: t('dashboard.revenueToday'),
-    value: formatAmount(metrics.value.revenueToday.value),
-    trend: metrics.value.revenueToday.trend ?? 'neutral',
-    delta: metrics.value.revenueToday.delta,
-  },
-  {
-    label: t('dashboard.pendingOrders'),
-    value: formatCount(metrics.value.pendingOrders.value),
-    trend: metrics.value.pendingOrders.trend ?? 'neutral',
-    delta: metrics.value.pendingOrders.delta,
-  },
-]);
-
-const analyticsHeaders = computed(() => [
-  { title: t('dashboard.metric'), key: 'metric' },
-  { title: t('dashboard.metricValue'), key: 'value', align: 'end' as const },
-  { title: t('dashboard.metricChange'), key: 'delta', align: 'end' as const },
-]);
-
-const analyticsRows = computed(() => [
-  {
-    metric: t('dashboard.totalSales'),
-    value: formatCount(metrics.value.totalSales.value),
-    delta: metrics.value.totalSales.delta || '-',
-    trendClass: metrics.value.totalSales.trend === 'up' ? 'text-success' : 'text-error',
-  },
-  {
-    metric: t('dashboard.activeCustomers'),
-    value: formatCount(metrics.value.activeCustomers.value),
-    delta: metrics.value.activeCustomers.delta || '-',
-    trendClass: metrics.value.activeCustomers.trend === 'up' ? 'text-success' : 'text-error',
-  },
-  {
-    metric: t('dashboard.revenueToday'),
-    value: formatAmount(metrics.value.revenueToday.value),
-    delta: metrics.value.revenueToday.delta || '-',
-    trendClass: metrics.value.revenueToday.trend === 'up' ? 'text-success' : 'text-error',
-  },
-  {
-    metric: t('dashboard.pendingOrders'),
-    value: formatCount(metrics.value.pendingOrders.value),
-    delta: metrics.value.pendingOrders.delta || '-',
-    trendClass: metrics.value.pendingOrders.trend === 'up' ? 'text-warning' : 'text-success',
-  },
-]);
-
-onMounted(() => {
-  void refresh();
-  refreshTimer = window.setInterval(() => {
-    void refresh();
-  }, 30000);
-});
-
-onUnmounted(() => {
-  if (refreshTimer !== null) {
-    window.clearInterval(refreshTimer);
-  }
-});
-</script>
diff --git a/apps/ui/src/modules/dashboard/providers/useDashboardMetrics.ts b/apps/ui/src/modules/dashboard/providers/useDashboardMetrics.ts
deleted file mode 100644
index b680280..0000000
--- a/apps/ui/src/modules/dashboard/providers/useDashboardMetrics.ts
+++ /dev/null
@@ -1,197 +0,0 @@
-﻿import { ref } from 'vue';
-import type { PagedResult } from '../../../ipc/contracts';
-import { invokeOrThrow } from '../../../ipc/invoke';
-import { buildParamsPayload } from '../../../ipc/payloads';
-import { mapErrorToArabic } from '../../../i18n/t';
-import type { Customer, Sale } from '../../../types/domain';
-
-type MetricTrend = 'up' | 'down' | 'neutral';
-
-type MetricValue = {
-  value: number;
-  trend?: MetricTrend;
-  delta?: string;
-};
-
-type MetricsShape = {
-  totalSales: MetricValue;
-  revenueToday: MetricValue;
-  activeCustomers: MetricValue;
-  pendingOrders: MetricValue;
-};
-
-const SALES_PAGE_SIZE = 200;
-const CUSTOMERS_PAGE_SIZE = 200;
-
-const createMetric = (value = 0): MetricValue => ({
-  value,
-  trend: 'neutral',
-});
-
-const createDefaultMetrics = (): MetricsShape => ({
-  totalSales: createMetric(0),
-  revenueToday: createMetric(0),
-  activeCustomers: createMetric(0),
-  pendingOrders: createMetric(0),
-});
-
-const toNumber = (value: unknown): number => {
-  if (typeof value === 'number' && Number.isFinite(value)) return value;
-  if (typeof value === 'string') {
-    const parsed = Number(value);
-    return Number.isFinite(parsed) ? parsed : 0;
-  }
-  return 0;
-};
-
-const getTodayRange = () => {
-  const day = new Date().toISOString().split('T')[0];
-  return {
-    startDate: `${day}T00:00:00.000Z`,
-    endDate: `${day}T23:59:59.999Z`,
-  };
-};
-
-const isPendingOrUnpaidSale = (sale: Sale): boolean => {
-  const status = String(sale.status ?? '').toLowerCase();
-  const remainingAmount = toNumber((sale as any).remainingAmount);
-  if (status === 'pending') return true;
-  if (status === 'cancelled') return false;
-  return remainingAmount > 0;
-};
-
-const isActiveCustomer = (customer: Customer): boolean => (customer as any).isActive !== false;
-
-async function fetchSalesPage(params: Record<string, unknown>): Promise<PagedResult<Sale>> {
-  return invokeOrThrow<PagedResult<Sale>>(
-    'sales:getAll',
-    buildParamsPayload('sales:getAll', params)
-  );
-}
-
-async function fetchCustomersPage(params: Record<string, unknown>): Promise<PagedResult<Customer>> {
-  return invokeOrThrow<PagedResult<Customer>>(
-    'customers:getAll',
-    buildParamsPayload('customers:getAll', params)
-  );
-}
-
-async function getSalesTotals(): Promise<{ totalSales: number; pendingOrders: number }> {
-  let page = 1;
-  let totalSales = 0;
-  let pendingOrders = 0;
-
-  while (true) {
-    const pageResult = await fetchSalesPage({ page, limit: SALES_PAGE_SIZE });
-    if (page === 1) {
-      totalSales = toNumber(pageResult.total);
-    }
-
-    pendingOrders += pageResult.items.filter(isPendingOrUnpaidSale).length;
-
-    if (pageResult.items.length === 0 || page * SALES_PAGE_SIZE >= totalSales) {
-      break;
-    }
-
-    page += 1;
-  }
-
-  return { totalSales, pendingOrders };
-}
-
-async function getRevenueToday(): Promise<number> {
-  const { startDate, endDate } = getTodayRange();
-
-  let page = 1;
-  let total = 0;
-  let revenueToday = 0;
-
-  while (true) {
-    const pageResult = await fetchSalesPage({
-      page,
-      limit: SALES_PAGE_SIZE,
-      startDate,
-      endDate,
-    });
-
-    if (page === 1) {
-      total = toNumber(pageResult.total);
-    }
-
-    for (const sale of pageResult.items) {
-      if (String(sale.status ?? '').toLowerCase() === 'cancelled') continue;
-      revenueToday += toNumber(sale.total);
-    }
-
-    if (pageResult.items.length === 0 || page * SALES_PAGE_SIZE >= total) {
-      break;
-    }
-
-    page += 1;
-  }
-
-  return revenueToday;
-}
-
-async function getActiveCustomersCount(): Promise<number> {
-  let offset = 0;
-  let total = 0;
-  let activeCustomers = 0;
-
-  while (true) {
-    const pageResult = await fetchCustomersPage({ limit: CUSTOMERS_PAGE_SIZE, offset });
-    if (offset === 0) {
-      total = toNumber(pageResult.total);
-    }
-
-    activeCustomers += pageResult.items.filter(isActiveCustomer).length;
-
-    if (pageResult.items.length === 0 || offset + CUSTOMERS_PAGE_SIZE >= total) {
-      break;
-    }
-
-    offset += CUSTOMERS_PAGE_SIZE;
-  }
-
-  return activeCustomers;
-}
-
-export function useDashboardMetrics() {
-  const metrics = ref<MetricsShape>(createDefaultMetrics());
-  const loading = ref(false);
-  const error = ref<string | null>(null);
-
-  const refresh = async (): Promise<void> => {
-    if (loading.value) return;
-
-    loading.value = true;
-    error.value = null;
-
-    try {
-      const [salesTotals, revenueToday, activeCustomers] = await Promise.all([
-        getSalesTotals(),
-        getRevenueToday(),
-        getActiveCustomersCount(),
-      ]);
-
-      metrics.value = {
-        totalSales: createMetric(salesTotals.totalSales),
-        revenueToday: createMetric(revenueToday),
-        activeCustomers: createMetric(activeCustomers),
-        pendingOrders: createMetric(salesTotals.pendingOrders),
-      };
-    } catch (err) {
-      error.value = mapErrorToArabic(err, 'errors.loadFailed');
-      console.error(err);
-    } finally {
-      loading.value = false;
-    }
-  };
-
-  return {
-    metrics,
-    loading,
-    error,
-    refresh,
-  };
-}
diff --git a/apps/ui/src/modules/products/routes.ts b/apps/ui/src/modules/products/routes.ts
index fd60493..3b2c556 100644
--- a/apps/ui/src/modules/products/routes.ts
+++ b/apps/ui/src/modules/products/routes.ts
@@ -1,12 +1,19 @@
 import type { RouteRecordRaw } from 'vue-router';
 import ProductWorkspaceView from '../../views/products/ProductWorkspaceView.vue';
+import BarcodeTemplateBuilderView from '../../views/products/BarcodeTemplateBuilderView.vue';
 
 export const productsRoutes: RouteRecordRaw[] = [
   {
     path: 'products',
     name: 'ProductWorkspace',
     component: ProductWorkspaceView,
-    meta: { requiresAccounting: true },
+    meta: {},
+  },
+  {
+    path: 'products/barcode-templates',
+    name: 'BarcodeTemplateBuilder',
+    component: BarcodeTemplateBuilderView,
+    meta: { requiresManageProducts: true },
   },
   {
     path: 'products/new',
@@ -15,7 +22,7 @@ export const productsRoutes: RouteRecordRaw[] = [
       name: 'ProductWorkspace',
       query: { ...to.query, action: 'create' },
     }),
-    meta: { requiresManageProducts: true, enableBarcode: 'product', requiresAccounting: true },
+    meta: { requiresManageProducts: true, enableBarcode: 'product' },
   },
   {
     path: 'products/:id',
@@ -24,7 +31,7 @@ export const productsRoutes: RouteRecordRaw[] = [
       name: 'ProductWorkspace',
       query: { ...to.query, productId: String(to.params.id) },
     }),
-    meta: { requiresAccounting: true },
+    meta: {},
   },
   {
     path: 'products/:id/edit',
@@ -33,7 +40,7 @@ export const productsRoutes: RouteRecordRaw[] = [
       name: 'ProductWorkspace',
       query: { ...to.query, productId: String(to.params.id), action: 'edit' },
     }),
-    meta: { requiresManageProducts: true, enableBarcode: 'product', requiresAccounting: true },
+    meta: { requiresManageProducts: true, enableBarcode: 'product' },
   },
   {
     path: 'products/:id/barcode',
@@ -42,6 +49,6 @@ export const productsRoutes: RouteRecordRaw[] = [
       name: 'ProductWorkspace',
       query: { ...to.query, productId: String(to.params.id), tab: 'units', action: 'barcode' },
     }),
-    meta: { requiresManageProducts: true, requiresAccounting: true },
+    meta: { requiresManageProducts: true },
   },
 ];
diff --git a/apps/ui/src/modules/users/routes.ts b/apps/ui/src/modules/users/routes.ts
index 40c70ef..e60c70e 100644
--- a/apps/ui/src/modules/users/routes.ts
+++ b/apps/ui/src/modules/users/routes.ts
@@ -1,11 +1,10 @@
 ﻿import type { RouteRecordRaw } from 'vue-router';
-import UsersView from '../../views/users/UsersView.vue';
 
 export const usersRoutes: RouteRecordRaw[] = [
   {
     path: 'users',
     name: 'Users',
-    component: UsersView,
+    redirect: { name: 'Settings', query: { tab: 'users' } },
     meta: { requiresManageSettings: true },
   },
 ];
diff --git a/apps/ui/src/stores/authStore.ts b/apps/ui/src/stores/authStore.ts
index 3cc9908..15efa9f 100644
--- a/apps/ui/src/stores/authStore.ts
+++ b/apps/ui/src/stores/authStore.ts
@@ -27,6 +27,7 @@ export const useAuthStore = defineStore('auth', () => {
   );
 
   const isInitialized = computed(() => setupStatus.value?.isInitialized ?? false);
+  const isSetupWizardCompleted = computed(() => setupStatus.value?.wizardCompleted ?? false);
 
   if (typeof window !== 'undefined') {
     registerUnauthorizedHandler(() => {
@@ -68,7 +69,12 @@ export const useAuthStore = defineStore('auth', () => {
       }
 
       // Mark as initialized locally
-      setupStatus.value = { isInitialized: true, hasUsers: true, hasCompanyInfo: true };
+      setupStatus.value = {
+        isInitialized: true,
+        hasUsers: true,
+        hasCompanyInfo: true,
+        wizardCompleted: false,
+      };
 
       return result;
     } catch (err: any) {
@@ -266,6 +272,7 @@ export const useAuthStore = defineStore('auth', () => {
     isAuthenticated,
     setupStatus,
     isInitialized,
+    isSetupWizardCompleted,
     loading,
     error,
     checkInitialSetup,
diff --git a/apps/ui/src/stores/barcodeStore.ts b/apps/ui/src/stores/barcodeStore.ts
index 006760d..90ff0ff 100644
--- a/apps/ui/src/stores/barcodeStore.ts
+++ b/apps/ui/src/stores/barcodeStore.ts
@@ -55,6 +55,15 @@ export const useBarcodeStore = defineStore('barcode', () => {
     return result;
   }
 
+  async function deleteTemplate(id: number) {
+    loading.value = true;
+    error.value = null;
+    const result = await barcodeClient.deleteTemplate(id);
+    if (!result.ok) error.value = result.error.message;
+    loading.value = false;
+    return result.ok;
+  }
+
   return {
     templates,
     printJobs,
@@ -63,6 +72,7 @@ export const useBarcodeStore = defineStore('barcode', () => {
     error,
     fetchTemplates,
     createTemplate,
+    deleteTemplate,
     fetchPrintJobs,
     createPrintJob,
   };
diff --git a/apps/ui/src/stores/featureFlagsStore.ts b/apps/ui/src/stores/featureFlagsStore.ts
index 14fc185..2083d91 100644
--- a/apps/ui/src/stores/featureFlagsStore.ts
+++ b/apps/ui/src/stores/featureFlagsStore.ts
@@ -1,6 +1,7 @@
 import { computed, ref } from 'vue';
 import { defineStore } from 'pinia';
 import { setupClient, type AccountingSetupStatus } from '../ipc/setupClient';
+import { settingsClient, type AllModuleSettings } from '../ipc/settingsClient';
 
 export const useFeatureFlagsStore = defineStore('featureFlags', () => {
   const initialized = ref(false);
@@ -9,6 +10,13 @@ export const useFeatureFlagsStore = defineStore('featureFlags', () => {
   const accountingEnabledDecision = ref<boolean | null>(null);
   const coaSeeded = ref(false);
 
+  // ── Module toggle state ──
+  const purchasesEnabled = ref(true);
+  const ledgersEnabled = ref(true);
+  const unitsEnabled = ref(true);
+  const paymentsOnInvoicesEnabled = ref(true);
+  const wizardCompleted = ref(false);
+
   const accountingEnabled = computed(() => accountingEnabledDecision.value === true);
   const accountingReady = computed(() => accountingEnabled.value && coaSeeded.value);
   const simpleMode = computed(() => accountingEnabledDecision.value === false);
@@ -20,20 +28,42 @@ export const useFeatureFlagsStore = defineStore('featureFlags', () => {
     error.value = null;
   }
 
+  function applyModuleSettings(data: AllModuleSettings): void {
+    // Do NOT overwrite accountingEnabledDecision here — applyStatus is the
+    // authoritative source (reads 'accounting.enabled' via setup:getAccountingSetupStatus).
+    // Only apply the per-module toggles.
+    purchasesEnabled.value = data.modules.purchasesEnabled;
+    ledgersEnabled.value = data.modules.ledgersEnabled;
+    unitsEnabled.value = data.modules.unitsEnabled;
+    paymentsOnInvoicesEnabled.value = data.modules.paymentsOnInvoicesEnabled;
+    wizardCompleted.value = data.wizardCompleted;
+  }
+
   async function hydrate(force = false): Promise<void> {
     if (loading.value) return;
     if (initialized.value && !force) return;
 
     loading.value = true;
-    const result = await setupClient.getAccountingSetupStatus();
-    if (result.ok) {
-      applyStatus(result.data);
+
+    // Fetch both accounting status and module settings in parallel
+    const [acctResult, moduleResult] = await Promise.all([
+      setupClient.getAccountingSetupStatus(),
+      settingsClient.getModules(),
+    ]);
+
+    if (acctResult.ok) {
+      applyStatus(acctResult.data);
     } else {
-      error.value = result.error.message;
+      error.value = acctResult.error.message;
       accountingEnabledDecision.value = true;
       coaSeeded.value = false;
       initialized.value = true;
     }
+
+    if (moduleResult.ok) {
+      applyModuleSettings(moduleResult.data);
+    }
+
     loading.value = false;
   }
 
@@ -46,7 +76,14 @@ export const useFeatureFlagsStore = defineStore('featureFlags', () => {
     accountingReady,
     simpleMode,
     coaSeeded,
+    // Module toggles
+    purchasesEnabled,
+    ledgersEnabled,
+    unitsEnabled,
+    paymentsOnInvoicesEnabled,
+    wizardCompleted,
     hydrate,
     applyStatus,
+    applyModuleSettings,
   };
 });
diff --git a/apps/ui/src/stores/productWorkspaceStore.ts b/apps/ui/src/stores/productWorkspaceStore.ts
index 906b0fd..288eb63 100644
--- a/apps/ui/src/stores/productWorkspaceStore.ts
+++ b/apps/ui/src/stores/productWorkspaceStore.ts
@@ -71,6 +71,11 @@ export const useProductWorkspaceStore = defineStore('productWorkspace', () => {
     search: '',
     limit: 50,
     offset: 0,
+    expiringSoonOnly: false,
+    lowStockOnly: false,
+    categoryId: undefined,
+    supplierId: undefined,
+    status: undefined,
   });
 
   const loading = reactive<LoadingState>(initialLoading());
@@ -96,14 +101,9 @@ export const useProductWorkspaceStore = defineStore('productWorkspace', () => {
     const page = Math.floor(offset / limit) + 1;
 
     const result = await productsClient.getAll({
-      search: filters.value.search,
+      ...filters.value,
+      expiringSoonOnly: filters.value.expiringSoonOnly || false,
       page,
-      limit,
-      categoryId: filters.value.categoryId,
-      supplierId: filters.value.supplierId,
-      status: filters.value.status,
-      lowStockOnly: filters.value.lowStockOnly,
-      expiringSoonOnly: filters.value.expiringSoonOnly,
     });
 
     if (result.ok) {
@@ -433,4 +433,3 @@ export const useProductWorkspaceStore = defineStore('productWorkspace', () => {
     loadProductWorkspace,
   };
 });
-
diff --git a/apps/ui/src/utils/receiptFormatter.ts b/apps/ui/src/utils/receiptFormatter.ts
index 9c78fe4..807c408 100644
--- a/apps/ui/src/utils/receiptFormatter.ts
+++ b/apps/ui/src/utils/receiptFormatter.ts
@@ -130,7 +130,8 @@ function formatCurrency(amount: number, currency: string): string {
   };
 
   const symbol = currencySymbols[currency] || currency;
-  return `${amount.toFixed(2)} ${symbol}`;
+  const decimals = currency === 'IQD' ? 0 : 2;
+  return `${Math.round(amount).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals })} ${symbol}`;
 }
 
 function formatTotal(
diff --git a/apps/ui/src/views/accounting/JournalEntriesView.vue b/apps/ui/src/views/accounting/JournalEntriesView.vue
index 341b586..304c425 100644
--- a/apps/ui/src/views/accounting/JournalEntriesView.vue
+++ b/apps/ui/src/views/accounting/JournalEntriesView.vue
@@ -12,7 +12,7 @@
     <v-card>
       <v-card-text>
         <v-row dense class="mb-4">
-          <v-col cols="12" sm="4">
+          <v-col cols="12" sm="3">
             <v-select
               v-model="sourceFilter"
               :items="sources"
@@ -24,6 +24,30 @@
               @update:model-value="onFilter"
             />
           </v-col>
+          <v-col cols="12" sm="3">
+            <v-text-field
+              v-model="dateFrom"
+              label="من تاريخ"
+              type="date"
+              variant="outlined"
+              density="compact"
+              hide-details
+              clearable
+              @update:model-value="onFilter"
+            />
+          </v-col>
+          <v-col cols="12" sm="3">
+            <v-text-field
+              v-model="dateTo"
+              label="إلى تاريخ"
+              type="date"
+              variant="outlined"
+              density="compact"
+              hide-details
+              clearable
+              @update:model-value="onFilter"
+            />
+          </v-col>
         </v-row>
 
         <v-data-table
@@ -67,6 +91,8 @@ import MoneyDisplay from '../../components/shared/MoneyDisplay.vue';
 const router = useRouter();
 const accountingStore = useAccountingStore();
 const sourceFilter = ref<string | null>(null);
+const dateFrom = ref<string | null>(null);
+const dateTo = ref<string | null>(null);
 
 const sources = [
   { title: 'مبيعات', value: 'sale' },
@@ -91,6 +117,10 @@ function sourceLabel(s?: string): string {
 onMounted(() => accountingStore.fetchJournalEntries());
 
 function onFilter() {
-  accountingStore.fetchJournalEntries({ sourceType: sourceFilter.value || undefined });
+  accountingStore.fetchJournalEntries({
+    sourceType: sourceFilter.value || undefined,
+    dateFrom: dateFrom.value || undefined,
+    dateTo: dateTo.value || undefined,
+  });
 }
 </script>
diff --git a/apps/ui/src/views/auth/SetupView.vue b/apps/ui/src/views/auth/SetupView.vue
index 149a8f0..01b33d5 100644
--- a/apps/ui/src/views/auth/SetupView.vue
+++ b/apps/ui/src/views/auth/SetupView.vue
@@ -352,8 +352,181 @@
                 <v-spacer />
                 <v-btn
                   color="primary"
-                  @click="submitSetup"
+                  @click="goToStep3"
                   :loading="authStore.loading || accountingLoading || accountingSeeding"
+                  :disabled="!isStep2Valid || setupIncompleteCount > 0"
+                >
+                  {{ t('setup.next') }}
+                  <v-icon end>mdi-arrow-left</v-icon>
+                </v-btn>
+              </v-card-actions>
+            </v-card>
+          </template>
+
+          <!-- Step 3: Module Toggles & Preferences -->
+          <template #item.3>
+            <v-card flat class="step-card">
+              <v-card-title class="text-subtitle-1 font-weight-bold px-0 pb-2">
+                إعدادات الوحدات
+              </v-card-title>
+              <p class="text-body-2 text-medium-emphasis mb-4">
+                اختر الوحدات التي تحتاجها. يمكنك تغييرها لاحقاً من الإعدادات.
+              </p>
+
+              <!-- Module toggles -->
+              <v-card variant="tonal" class="pa-4 mb-4">
+                <div class="d-flex align-center ga-2 mb-3">
+                  <v-icon size="20" color="primary">mdi-puzzle-outline</v-icon>
+                  <span class="text-subtitle-2 font-weight-bold">الوحدات الاختيارية</span>
+                </div>
+
+                <v-switch
+                  v-model="moduleToggles.purchasesEnabled"
+                  color="primary"
+                  density="compact"
+                  hide-details
+                  label="المشتريات والموردين"
+                  class="mb-2"
+                />
+                <v-switch
+                  v-model="moduleToggles.ledgersEnabled"
+                  color="primary"
+                  density="compact"
+                  hide-details
+                  label="دفاتر الحسابات (ذمم العملاء / الموردين)"
+                  class="mb-2"
+                />
+                <v-switch
+                  v-model="moduleToggles.unitsEnabled"
+                  color="primary"
+                  density="compact"
+                  hide-details
+                  label="وحدات القياس المتعددة للمنتجات"
+                  class="mb-2"
+                />
+                <v-switch
+                  v-model="moduleToggles.paymentsOnInvoicesEnabled"
+                  color="primary"
+                  density="compact"
+                  hide-details
+                  label="الدفع على الفواتير (أقساط)"
+                />
+              </v-card>
+
+              <!-- Invoice settings -->
+              <v-card variant="tonal" class="pa-4 mb-4">
+                <div class="d-flex align-center ga-2 mb-3">
+                  <v-icon size="20" color="primary">mdi-receipt-text-outline</v-icon>
+                  <span class="text-subtitle-2 font-weight-bold">إعدادات الفاتورة</span>
+                </div>
+
+                <v-row dense>
+                  <v-col cols="12" md="6">
+                    <v-text-field
+                      v-model="invoiceSettings.prefix"
+                      label="بادئة رقم الفاتورة"
+                      placeholder="INV-"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                  <v-col cols="12" md="6">
+                    <v-select
+                      v-model="invoiceSettings.paperSize"
+                      label="حجم الورق"
+                      :items="[
+                        { title: 'حراري (80mm)', value: 'thermal' },
+                        { title: 'A4', value: 'a4' },
+                        { title: 'A5', value: 'a5' },
+                      ]"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                  <v-col cols="12">
+                    <v-text-field
+                      v-model="invoiceSettings.footerNotes"
+                      label="ملاحظات أسفل الفاتورة"
+                      placeholder="شكراً لتعاملكم معنا"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                  <v-col cols="12">
+                    <v-switch
+                      v-model="invoiceSettings.showQr"
+                      color="primary"
+                      density="compact"
+                      hide-details
+                      label="عرض رمز QR في الفاتورة"
+                    />
+                  </v-col>
+                </v-row>
+              </v-card>
+
+              <!-- Notification settings -->
+              <v-card variant="tonal" class="pa-4 mb-4">
+                <div class="d-flex align-center ga-2 mb-3">
+                  <v-icon size="20" color="primary">mdi-bell-outline</v-icon>
+                  <span class="text-subtitle-2 font-weight-bold">إعدادات التنبيهات</span>
+                </div>
+
+                <v-row dense>
+                  <v-col cols="12" md="4">
+                    <v-text-field
+                      v-model.number="notificationSettings.lowStockThreshold"
+                      label="حد المخزون المنخفض"
+                      type="number"
+                      :min="0"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                  <v-col cols="12" md="4">
+                    <v-text-field
+                      v-model.number="notificationSettings.expiryDays"
+                      label="أيام تنبيه انتهاء الصلاحية"
+                      type="number"
+                      :min="0"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                  <v-col cols="12" md="4">
+                    <v-text-field
+                      v-model.number="notificationSettings.debtReminderCount"
+                      label="عدد تذكيرات الذمم"
+                      type="number"
+                      :min="0"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                  <v-col cols="12" md="4">
+                    <v-text-field
+                      v-model.number="notificationSettings.debtReminderIntervalDays"
+                      label="فاصل تذكير الذمم (أيام)"
+                      type="number"
+                      :min="0"
+                      density="comfortable"
+                      variant="outlined"
+                    />
+                  </v-col>
+                </v-row>
+              </v-card>
+
+              <v-card-actions class="px-0 pt-4">
+                <v-btn variant="text" @click="currentStep = 2">
+                  <v-icon start>mdi-arrow-right</v-icon>
+                  {{ t('setup.back') }}
+                </v-btn>
+                <v-spacer />
+                <v-btn
+                  color="primary"
+                  @click="submitSetup"
+                  :loading="
+                    authStore.loading || accountingLoading || accountingSeeding || savingWizard
+                  "
                   :disabled="!canSubmitSetup"
                   prepend-icon="mdi-check"
                 >
@@ -374,6 +547,7 @@ import { useRouter } from 'vue-router';
 import { t, mapErrorToArabic } from '../../i18n/t';
 import { useAuthStore } from '../../stores/authStore';
 import { setupClient } from '../../ipc';
+import { settingsClient, type AllModuleSettings } from '../../ipc/settingsClient';
 import type { AccountingSetupStatus } from '../../ipc/setupClient';
 
 const authStore = useAuthStore();
@@ -422,9 +596,39 @@ const admin = reactive({
 
 const currencies = ['IQD', 'USD', 'EUR', 'SAR', 'AED', 'KWD', 'TRY'];
 
+const savingWizard = ref(false);
+
+const moduleToggles = reactive({
+  purchasesEnabled: true,
+  ledgersEnabled: true,
+  unitsEnabled: false,
+  paymentsOnInvoicesEnabled: true,
+});
+
+const invoiceSettings = reactive({
+  templateActiveId: 'default',
+  prefix: 'INV-',
+  paperSize: 'thermal' as 'thermal' | 'a4' | 'a5',
+  logo: '',
+  footerNotes: '',
+  layoutDirection: 'rtl' as 'rtl' | 'ltr',
+  showQr: false,
+  showBarcode: false,
+});
+
+const notificationSettings = reactive({
+  lowStockThreshold: 5,
+  expiryDays: 30,
+  debtReminderCount: 3,
+  debtReminderIntervalDays: 7,
+});
+
+const requiresAdminBootstrap = computed(() => !authStore.isInitialized);
+
 const stepItems = computed(() => [
   { value: 1, title: t('setup.step1') },
   { value: 2, title: t('setup.step2') },
+  { value: 3, title: 'الوحدات والإعدادات' },
 ]);
 
 const setupIncompleteCount = computed(() => {
@@ -436,6 +640,7 @@ const setupIncompleteCount = computed(() => {
 
 const isStep2Valid = computed(
   () =>
+    !requiresAdminBootstrap.value ||
     admin.fullName.trim().length >= 3 &&
     admin.username.trim().length >= 3 &&
     admin.password.length >= 6
@@ -473,6 +678,60 @@ function goToStep2() {
   currentStep.value = 2;
 }
 
+function goToStep3() {
+  if (requiresAdminBootstrap.value && step2FormRef.value && !step2FormRef.value.validate()) return;
+  if (!isStep2Valid.value) return;
+  if (setupIncompleteCount.value > 0) {
+    formError.value = t('setup.completeAccountingStep');
+    return;
+  }
+  currentStep.value = 3;
+}
+
+function applyWizardDefaults(data: AllModuleSettings): void {
+  moduleToggles.purchasesEnabled = data.modules.purchasesEnabled;
+  moduleToggles.ledgersEnabled = data.modules.ledgersEnabled;
+  moduleToggles.unitsEnabled = data.modules.unitsEnabled;
+  moduleToggles.paymentsOnInvoicesEnabled = data.modules.paymentsOnInvoicesEnabled;
+
+  notificationSettings.lowStockThreshold = data.notifications.lowStockThreshold;
+  notificationSettings.expiryDays = data.notifications.expiryDays;
+  notificationSettings.debtReminderCount = data.notifications.debtReminderCount;
+  notificationSettings.debtReminderIntervalDays = data.notifications.debtReminderIntervalDays;
+
+  invoiceSettings.templateActiveId = data.invoice.templateActiveId;
+  invoiceSettings.prefix = data.invoice.prefix;
+  invoiceSettings.paperSize = data.invoice.paperSize;
+  invoiceSettings.logo = data.invoice.logo;
+  invoiceSettings.footerNotes = data.invoice.footerNotes;
+  invoiceSettings.layoutDirection = data.invoice.layoutDirection;
+  invoiceSettings.showQr = data.invoice.showQr;
+  invoiceSettings.showBarcode = data.invoice.showBarcode;
+}
+
+async function loadWizardDefaults() {
+  const [modulesResult, companyResult] = await Promise.all([
+    settingsClient.getModules(),
+    settingsClient.getCompany(),
+  ]);
+
+  if (modulesResult.ok) {
+    applyWizardDefaults(modulesResult.data);
+  }
+
+  if (companyResult.ok && companyResult.data) {
+    company.name = companyResult.data.name;
+    company.address = companyResult.data.address || '';
+    company.phone = companyResult.data.phone || '';
+    company.phone2 = companyResult.data.phone2 || '';
+    company.email = companyResult.data.email || '';
+    company.taxId = companyResult.data.taxId || '';
+    company.currency = companyResult.data.currency || company.currency;
+    company.lowStockThreshold = companyResult.data.lowStockThreshold ?? company.lowStockThreshold;
+  }
+
+}
+
 function applyAccountingStatus(status: AccountingSetupStatus): void {
   accountingEnabled.value = status.enabled;
   accountingSeeded.value = status.seeded;
@@ -544,36 +803,78 @@ async function seedChartOfAccounts() {
 
 async function submitSetup() {
   formError.value = null;
-  if (step2FormRef.value && !step2FormRef.value.validate()) return;
+  if (requiresAdminBootstrap.value && step2FormRef.value && !step2FormRef.value.validate()) return;
   if (setupIncompleteCount.value > 0) {
     formError.value = t('setup.completeAccountingStep');
     return;
   }
 
   try {
-    await authStore.initializeApp({
-      admin: {
-        username: admin.username.trim(),
-        password: admin.password,
-        fullName: admin.fullName.trim(),
-        phone: admin.phone || undefined,
+    if (requiresAdminBootstrap.value) {
+      await authStore.initializeApp({
+        admin: {
+          username: admin.username.trim(),
+          password: admin.password,
+          fullName: admin.fullName.trim(),
+          phone: admin.phone || undefined,
+        },
+        companySettings: {
+          name: company.name.trim(),
+          address: company.address || null,
+          phone: company.phone || null,
+          phone2: company.phone2 || null,
+          email: company.email || null,
+          taxId: company.taxId || null,
+          logo: null,
+          currency: company.currency,
+          lowStockThreshold: company.lowStockThreshold,
+        },
+      });
+    }
+
+    savingWizard.value = true;
+    const wizardResult = await settingsClient.completeWizard({
+      modules: {
+        accountingEnabled: accountingEnabled.value === true,
+        purchasesEnabled: moduleToggles.purchasesEnabled,
+        ledgersEnabled: moduleToggles.ledgersEnabled,
+        unitsEnabled: moduleToggles.unitsEnabled,
+        paymentsOnInvoicesEnabled: moduleToggles.paymentsOnInvoicesEnabled,
       },
-      companySettings: {
-        name: company.name.trim(),
-        address: company.address || null,
-        phone: company.phone || null,
-        phone2: company.phone2 || null,
-        email: company.email || null,
-        taxId: company.taxId || null,
-        logo: null,
-        currency: company.currency,
-        lowStockThreshold: company.lowStockThreshold,
+      notifications: {
+        lowStockThreshold: notificationSettings.lowStockThreshold,
+        expiryDays: notificationSettings.expiryDays,
+        debtReminderCount: notificationSettings.debtReminderCount,
+        debtReminderIntervalDays: notificationSettings.debtReminderIntervalDays,
+      },
+      invoice: {
+        templateActiveId: invoiceSettings.templateActiveId,
+        prefix: invoiceSettings.prefix,
+        paperSize: invoiceSettings.paperSize,
+        logo: invoiceSettings.logo,
+        footerNotes: invoiceSettings.footerNotes,
+        layoutDirection: invoiceSettings.layoutDirection,
+        showQr: invoiceSettings.showQr,
+        showBarcode: invoiceSettings.showBarcode,
       },
     });
+    savingWizard.value = false;
+
+    if (!wizardResult.ok) {
+      formError.value = mapErrorToArabic(wizardResult.error.message, 'errors.saveFailed');
+      return;
+    }
+
+    authStore.setupStatus = {
+      isInitialized: true,
+      hasUsers: true,
+      hasCompanyInfo: true,
+      wizardCompleted: true,
+    };
 
-    // Success — redirect to login
     await router.replace({ name: 'Login' });
   } catch (err: any) {
+    savingWizard.value = false;
     formError.value = mapErrorToArabic(err, 'errors.initializeFailed');
     console.error('[Setup] Initialization failed:', err);
   }
@@ -588,9 +889,18 @@ watch(
   }
 );
 
-onMounted(() => {
+onMounted(async () => {
+  if (!authStore.setupStatus) {
+    try {
+      await authStore.checkInitialSetup();
+    } catch {
+      // Keep setup screen visible; load failures are surfaced via component state.
+    }
+  }
+
+  await loadWizardDefaults();
   baseCurrency.value = company.currency;
-  void loadAccountingStatus();
+  await loadAccountingStatus();
 });
 </script>
 
diff --git a/apps/ui/src/views/dashboard/DashboardView.vue b/apps/ui/src/views/dashboard/DashboardView.vue
deleted file mode 100644
index 929f5e9..0000000
--- a/apps/ui/src/views/dashboard/DashboardView.vue
+++ /dev/null
@@ -1,9 +0,0 @@
-<template>
-  <v-container>
-    <dashboard-module-view />
-  </v-container>
-</template>
-
-<script setup lang="ts">
-import DashboardModuleView from '../../modules/dashboard/DashboardView.vue';
-</script>
diff --git a/apps/ui/src/views/inventory/StockAdjustmentView.vue b/apps/ui/src/views/inventory/StockAdjustmentView.vue
index 32ee2d9..072c4c0 100644
--- a/apps/ui/src/views/inventory/StockAdjustmentView.vue
+++ b/apps/ui/src/views/inventory/StockAdjustmentView.vue
@@ -6,7 +6,7 @@
       </v-col>
     </v-row>
 
-    <v-card max-width="600">
+    <v-card max-width="700">
       <v-card-text>
         <v-form ref="formRef" @submit.prevent="onSubmit">
           <v-autocomplete
@@ -19,7 +19,28 @@
             variant="outlined"
             density="compact"
             class="mb-3"
+            @update:model-value="onProductChange"
           />
+
+          <!-- Batch selector for expiry-tracked products -->
+          <v-select
+            v-if="selectedProduct?.isExpire && batches.length > 0"
+            v-model="form.batchId"
+            :items="batches"
+            :item-title="
+              (b: any) =>
+                `${b.batchNumber} (متوفر: ${b.quantityOnHand}${b.expiryDate ? ' — انتهاء: ' + b.expiryDate : ''})`
+            "
+            item-value="id"
+            label="الدفعة"
+            variant="outlined"
+            density="compact"
+            class="mb-3"
+            clearable
+            hint="اختر الدفعة للمنتجات التي تتتبع تاريخ الانتهاء"
+            persistent-hint
+          />
+
           <v-select
             v-model="form.reason"
             :items="reasons"
@@ -47,6 +68,53 @@
             class="mb-3"
           />
 
+          <!-- Accounting impact preview -->
+          <v-card
+            v-if="form.productId && form.quantityBase !== 0"
+            variant="tonal"
+            color="blue-lighten-5"
+            class="mb-4"
+          >
+            <v-card-title class="text-subtitle-2 font-weight-bold">
+              <v-icon size="18" class="me-1">mdi-calculator</v-icon>
+              الأثر المحاسبي المتوقع
+            </v-card-title>
+            <v-card-text>
+              <v-table density="compact">
+                <thead>
+                  <tr>
+                    <th>الحساب</th>
+                    <th class="text-end">مدين</th>
+                    <th class="text-end">دائن</th>
+                  </tr>
+                </thead>
+                <tbody>
+                  <tr>
+                    <td>{{ form.quantityBase > 0 ? 'المخزون' : 'خسائر المخزون' }}</td>
+                    <td class="text-end" style="direction: ltr; unicode-bidi: embed">
+                      {{ form.quantityBase > 0 ? estimatedCost.toLocaleString('en-US') : '' }}
+                    </td>
+                    <td class="text-end" style="direction: ltr; unicode-bidi: embed">
+                      {{ form.quantityBase < 0 ? estimatedCost.toLocaleString('en-US') : '' }}
+                    </td>
+                  </tr>
+                  <tr>
+                    <td>{{ form.quantityBase > 0 ? 'تعديل المخزون (دائن)' : 'المخزون' }}</td>
+                    <td class="text-end" style="direction: ltr; unicode-bidi: embed">
+                      {{ form.quantityBase < 0 ? estimatedCost.toLocaleString('en-US') : '' }}
+                    </td>
+                    <td class="text-end" style="direction: ltr; unicode-bidi: embed">
+                      {{ form.quantityBase > 0 ? estimatedCost.toLocaleString('en-US') : '' }}
+                    </td>
+                  </tr>
+                </tbody>
+              </v-table>
+              <div class="text-caption text-medium-emphasis mt-2">
+                * الأثر الفعلي يُحسب من الخادم حسب تكلفة الدفعات (FIFO)
+              </div>
+            </v-card-text>
+          </v-card>
+
           <div class="d-flex ga-3">
             <v-btn type="submit" color="primary" :loading="inventoryStore.loading">تنفيذ</v-btn>
             <v-btn variant="text" @click="router.back()">إلغاء</v-btn>
@@ -58,7 +126,7 @@
 </template>
 
 <script setup lang="ts">
-import { ref, reactive, onMounted } from 'vue';
+import { ref, reactive, computed, onMounted } from 'vue';
 import { useRouter } from 'vue-router';
 import { useInventoryStore } from '../../stores/inventoryStore';
 import { productsClient } from '../../ipc';
@@ -67,7 +135,16 @@ import { generateIdempotencyKey } from '../../utils/idempotency';
 const router = useRouter();
 const inventoryStore = useInventoryStore();
 const formRef = ref();
-const products = ref<{ id: number; name: string }[]>([]);
+const products = ref<{ id: number; name: string; isExpire?: boolean; costPrice?: number }[]>([]);
+const batches = ref<any[]>([]);
+
+const selectedProduct = computed(() => products.value.find((p) => p.id === form.productId) ?? null);
+
+const estimatedCost = computed(() => {
+  if (!form.productId || form.quantityBase === 0) return 0;
+  const product = selectedProduct.value;
+  return Math.abs(form.quantityBase) * (product?.costPrice ?? 0);
+});
 
 const reasons = [
   { title: 'تعديل يدوي', value: 'manual' },
@@ -80,11 +157,30 @@ const form = reactive({
   reason: 'manual' as 'manual' | 'damage' | 'opening',
   quantityBase: 0,
   notes: '',
+  batchId: null as number | null,
 });
 
+async function onProductChange() {
+  form.batchId = null;
+  batches.value = [];
+  if (form.productId) {
+    const product = selectedProduct.value;
+    if (product?.isExpire) {
+      const res = await productsClient.getBatches(form.productId);
+      if (res.ok) batches.value = res.data ?? [];
+    }
+  }
+}
+
 onMounted(async () => {
   const res = await productsClient.getAll();
-  if (res.ok) products.value = res.data.items.map((p: any) => ({ id: p.id, name: p.name }));
+  if (res.ok)
+    products.value = res.data.items.map((p: any) => ({
+      id: p.id,
+      name: p.name,
+      isExpire: p.isExpire,
+      costPrice: p.costPrice,
+    }));
 });
 
 async function onSubmit() {
diff --git a/apps/ui/src/views/products/ProductDetailView.vue b/apps/ui/src/views/products/ProductDetailView.vue
index 0bd2667..9b385ab 100644
--- a/apps/ui/src/views/products/ProductDetailView.vue
+++ b/apps/ui/src/views/products/ProductDetailView.vue
@@ -60,6 +60,7 @@
         <v-tab value="movements">حركات المخزون</v-tab>
         <v-tab value="batches">الدفعات</v-tab>
         <v-tab value="units">الوحدات</v-tab>
+        <v-tab value="audit">التدقيق</v-tab>
       </v-tabs>
 
       <v-window v-model="activeTab">
@@ -87,12 +88,15 @@
 
         <v-window-item value="batches">
           <v-card>
-            <v-card-text v-if="!product.isExpire" class="text-center py-8 text-medium-emphasis">
+            <v-card-text
+              v-if="!product.isExpire && batchList.length === 0"
+              class="text-center py-8 text-medium-emphasis"
+            >
               <v-icon size="48" color="grey-lighten-1" class="mb-2">mdi-package-variant</v-icon>
               <div>هذا المنتج لا يتتبع الدفعات</div>
             </v-card-text>
             <v-card-text
-              v-else-if="movements.length === 0"
+              v-else-if="batchList.length === 0"
               class="text-center py-8 text-medium-emphasis"
             >
               <v-icon size="48" color="grey-lighten-1" class="mb-2">mdi-package-variant</v-icon>
@@ -101,14 +105,21 @@
             <template v-else>
               <v-data-table
                 :headers="batchHeaders"
-                :items="batchSummary"
+                :items="batchList"
                 density="compact"
                 :items-per-page="10"
+                :loading="batchesLoading"
               >
                 <template #item.expiryDate="{ item }">
                   <v-chip
                     v-if="item.expiryDate"
-                    :color="isExpiringSoon(item.expiryDate) ? 'error' : 'grey'"
+                    :color="
+                      isExpiringSoon(item.expiryDate)
+                        ? 'error'
+                        : isExpiringMedium(item.expiryDate)
+                          ? 'warning'
+                          : 'success'
+                    "
                     size="small"
                     variant="tonal"
                   >
@@ -116,6 +127,30 @@
                   </v-chip>
                   <span v-else>—</span>
                 </template>
+                <template #item.costPerUnit="{ item }">
+                  <MoneyDisplay v-if="item.costPerUnit" :amount="item.costPerUnit" size="sm" />
+                  <span v-else>—</span>
+                </template>
+                <template #item.status="{ item }">
+                  <v-chip
+                    size="x-small"
+                    variant="tonal"
+                    :color="
+                      item.status === 'depleted'
+                        ? 'grey'
+                        : item.status === 'active'
+                          ? 'success'
+                          : 'info'
+                    "
+                  >
+                    {{ batchStatusLabel(item.status) }}
+                  </v-chip>
+                </template>
+                <template #item.quantityOnHand="{ item }">
+                  <span :class="{ 'text-error font-weight-bold': item.quantityOnHand === 0 }">
+                    {{ item.quantityOnHand }}
+                  </span>
+                </template>
               </v-data-table>
             </template>
           </v-card>
@@ -134,6 +169,10 @@
             </v-card-text>
           </v-card>
         </v-window-item>
+
+        <v-window-item value="audit">
+          <AuditLogTab v-if="product?.id" entity-type="product" :entity-id="product.id" />
+        </v-window-item>
       </v-window>
     </template>
 
@@ -148,6 +187,7 @@ import { productsClient, inventoryClient } from '../../ipc';
 import type { Product } from '../../types/domain';
 import MoneyDisplay from '../../components/shared/MoneyDisplay.vue';
 import MovementHistoryTable from '../../components/shared/MovementHistoryTable.vue';
+import AuditLogTab from '../../components/shared/AuditLogTab.vue';
 
 const route = useRoute();
 const router = useRouter();
@@ -157,51 +197,50 @@ const product = ref<Product | null>(null);
 const activeTab = ref('info');
 const movements = ref<any[]>([]);
 const movementsLoading = ref(false);
+const batchList = ref<any[]>([]);
+const batchesLoading = ref(false);
 
 const batchHeaders = [
   { title: 'رقم الدفعة', key: 'batchNumber' },
   { title: 'تاريخ الانتهاء', key: 'expiryDate' },
-  { title: 'الكمية', key: 'quantity', align: 'center' as const },
+  { title: 'الكمية المستلمة', key: 'quantityReceived', align: 'center' as const },
+  { title: 'الكمية المتاحة', key: 'quantityOnHand', align: 'center' as const },
+  { title: 'تكلفة الوحدة', key: 'costPerUnit', align: 'end' as const },
+  { title: 'الحالة', key: 'status', width: '90px' },
 ];
 
-// Derive batch summary from movements (until dedicated batch query exists)
-const batchSummary = computed(() => {
-  const batches = new Map<
-    string,
-    { batchNumber: string; expiryDate: string | null; quantity: number }
-  >();
-  for (const m of movements.value) {
-    if (!m.batchNumber) continue;
-    const key = m.batchNumber;
-    const existing = batches.get(key);
-    const qty = m.movementType === 'in' ? m.quantity : -m.quantity;
-    if (existing) {
-      existing.quantity += qty;
-    } else {
-      batches.set(key, {
-        batchNumber: m.batchNumber,
-        expiryDate: m.expiryDate ?? null,
-        quantity: qty,
-      });
-    }
-  }
-  return Array.from(batches.values()).filter((b) => b.quantity > 0);
-});
-
 function isExpiringSoon(dateStr: string): boolean {
   const diff = new Date(dateStr).getTime() - Date.now();
   return diff < 30 * 24 * 60 * 60 * 1000; // 30 days
 }
 
+function isExpiringMedium(dateStr: string): boolean {
+  const diff = new Date(dateStr).getTime() - Date.now();
+  return diff < 90 * 24 * 60 * 60 * 1000; // 90 days
+}
+
+function batchStatusLabel(status?: string): string {
+  if (status === 'depleted') return 'نفذ';
+  if (status === 'active') return 'نشط';
+  return status ?? '—';
+}
+
 onMounted(async () => {
   const id = Number(route.params.id);
   const res = await productsClient.getById(id);
   if (res.ok) product.value = res.data;
   loading.value = false;
 
+  // Fetch movements
   movementsLoading.value = true;
   const mRes = await inventoryClient.getMovements({ productId: id });
   if (mRes.ok) movements.value = mRes.data.items;
   movementsLoading.value = false;
+
+  // Fetch batches from dedicated API (not derived from movements)
+  batchesLoading.value = true;
+  const bRes = await productsClient.getBatches(id);
+  if (bRes.ok) batchList.value = bRes.data ?? [];
+  batchesLoading.value = false;
 });
 </script>
diff --git a/apps/ui/src/views/products/ProductFormView.vue b/apps/ui/src/views/products/ProductFormView.vue
index c6790b3..4b3257c 100644
--- a/apps/ui/src/views/products/ProductFormView.vue
+++ b/apps/ui/src/views/products/ProductFormView.vue
@@ -309,7 +309,7 @@ function formatPrice(price: number): string {
     style: 'currency',
     currency: 'IQD',
     minimumFractionDigits: 0,
-    maximumFractionDigits: 2,
+    maximumFractionDigits: 0,
     numberingSystem: 'latn',
   }).format(price);
 }
diff --git a/apps/ui/src/views/products/ProductWorkspaceView.vue b/apps/ui/src/views/products/ProductWorkspaceView.vue
index 2e8fd20..b021626 100644
--- a/apps/ui/src/views/products/ProductWorkspaceView.vue
+++ b/apps/ui/src/views/products/ProductWorkspaceView.vue
@@ -410,11 +410,14 @@ async function selectProduct(productId: number): Promise<void> {
 }
 
 async function onFiltersChange(filters: ProductWorkspaceFilters): Promise<void> {
-  await workspaceStore.fetchProducts({
+  const result = await workspaceStore.fetchProducts({
     ...workspaceStore.filters,
+
     ...filters,
     offset: 0,
   });
+
+  console.log('fetchProducts result', result);
 }
 
 async function onPaginationChange(pagination: { limit: number; offset: number }): Promise<void> {
diff --git a/apps/ui/src/views/products/ProductsListView.vue b/apps/ui/src/views/products/ProductsListView.vue
index 9b9cb2a..ea6aa03 100644
--- a/apps/ui/src/views/products/ProductsListView.vue
+++ b/apps/ui/src/views/products/ProductsListView.vue
@@ -134,8 +134,8 @@ function statusBadgeClass(status: string): string {
 
 function formatAmount(value: number): string {
   return new Intl.NumberFormat('ar-IQ', {
-    minimumFractionDigits: 2,
-    maximumFractionDigits: 2,
+    minimumFractionDigits: 0,
+    maximumFractionDigits: 0,
   }).format(value);
 }
 
diff --git a/apps/ui/src/views/purchases/PurchaseFormView.vue b/apps/ui/src/views/purchases/PurchaseFormView.vue
index 70743d6..3576306 100644
--- a/apps/ui/src/views/purchases/PurchaseFormView.vue
+++ b/apps/ui/src/views/purchases/PurchaseFormView.vue
@@ -75,6 +75,7 @@
                     variant="plain"
                     density="compact"
                     hide-details
+                    @update:model-value="onProductSelected(line)"
                   />
                 </td>
                 <td>
@@ -119,10 +120,20 @@
                     variant="plain"
                     density="compact"
                     hide-details
+                    :rules="
+                      line.requiresExpiry ? [(v: string) => !!v || 'تاريخ الانتهاء مطلوب'] : []
+                    "
+                    :class="{ 'border-error': line.requiresExpiry && !line.expiryDate }"
                   />
+                  <div
+                    v-if="line.requiresExpiry && !line.expiryDate"
+                    class="text-error text-caption"
+                  >
+                    مطلوب
+                  </div>
                 </td>
                 <td>
-                  <MoneyDisplay :amount="line.quantity * line.unitCost" size="sm" />
+                  <MoneyDisplay :amount="Math.round(line.quantity * line.unitCost)" size="sm" />
                 </td>
                 <td>
                   <v-btn
@@ -136,6 +147,22 @@
               </tr>
             </tbody>
           </v-table>
+
+          <!-- Validation warning for missing expiry dates -->
+          <v-alert
+            v-if="missingExpiryLines.length > 0"
+            type="warning"
+            variant="tonal"
+            density="compact"
+            class="mt-3"
+          >
+            منتجات تتطلب تاريخ انتهاء:
+            {{
+              missingExpiryLines
+                .map((l) => productsMap.get(l.productId!)?.name ?? 'غير معروف')
+                .join('، ')
+            }}
+          </v-alert>
         </v-card-text>
       </v-card>
 
@@ -192,7 +219,8 @@ const router = useRouter();
 const purchasesStore = usePurchasesStore();
 const suppliersStore = useSuppliersStore();
 const formRef = ref();
-const products = ref<{ id: number; name: string }[]>([]);
+const products = ref<{ id: number; name: string; isExpire?: boolean }[]>([]);
+const productsMap = ref<Map<number, { id: number; name: string; isExpire?: boolean }>>(new Map());
 
 const form = reactive({
   supplierId: null as number | null,
@@ -210,19 +238,43 @@ const form = reactive({
       unitCost: 0,
       batchNumber: '',
       expiryDate: '',
+      requiresExpiry: false,
     },
   ],
 });
 
-const subtotal = computed(() => form.items.reduce((s, l) => s + l.quantity * l.unitCost, 0));
-const grandTotal = computed(() => subtotal.value - form.discount + form.tax);
+const subtotal = computed(() =>
+  form.items.reduce((s, l) => s + Math.round(l.quantity * l.unitCost), 0)
+);
+const grandTotal = computed(() => Math.round(subtotal.value - form.discount + form.tax));
+
+// Lines that require expiry date but don't have one
+const missingExpiryLines = computed(() =>
+  form.items.filter((l) => l.requiresExpiry && !l.expiryDate)
+);
 
 onMounted(async () => {
   suppliersStore.fetchSuppliers();
   const res = await productsClient.getAll();
-  if (res.ok) products.value = res.data.items.map((p: any) => ({ id: p.id, name: p.name }));
+  if (res.ok) {
+    products.value = res.data.items.map((p: any) => ({
+      id: p.id,
+      name: p.name,
+      isExpire: p.isExpire,
+    }));
+    productsMap.value = new Map(products.value.map((p) => [p.id, p]));
+  }
 });
 
+function onProductSelected(line: (typeof form.items)[0]) {
+  if (line.productId) {
+    const product = productsMap.value.get(line.productId);
+    line.requiresExpiry = !!product?.isExpire;
+  } else {
+    line.requiresExpiry = false;
+  }
+}
+
 function addLine() {
   form.items.push({
     productId: null,
@@ -232,6 +284,7 @@ function addLine() {
     unitCost: 0,
     batchNumber: '',
     expiryDate: '',
+    requiresExpiry: false,
   });
 }
 
@@ -239,6 +292,11 @@ async function onSubmit() {
   const { valid } = await formRef.value.validate();
   if (!valid) return;
 
+  // Block submit if any expiry-tracked product is missing expiryDate
+  if (missingExpiryLines.value.length > 0) {
+    return;
+  }
+
   const result = await purchasesStore.createPurchase({
     supplierId: form.supplierId!,
     invoiceNumber: form.invoiceNumber,
diff --git a/apps/ui/src/views/sales/SaleDetailsView.vue b/apps/ui/src/views/sales/SaleDetailsView.vue
index 48c615f..f11f589 100644
--- a/apps/ui/src/views/sales/SaleDetailsView.vue
+++ b/apps/ui/src/views/sales/SaleDetailsView.vue
@@ -144,6 +144,49 @@
               <template #item.subtotal="{ item }">
                 <span class="font-weight-bold">{{ formatAmount(item.subtotal) }}</span>
               </template>
+              <!-- Expandable row: per-item batch depletion (FIFO) -->
+              <template #expanded-row="{ columns, item }">
+                <td :colspan="columns.length" class="pa-4 bg-grey-lighten-5">
+                  <div class="text-caption font-weight-bold mb-2">تفاصيل الدفعات (FIFO)</div>
+                  <v-table v-if="item.depletions?.length" density="compact">
+                    <thead>
+                      <tr>
+                        <th>رقم الدفعة</th>
+                        <th>تاريخ الانتهاء</th>
+                        <th class="text-center">الكمية</th>
+                        <th class="text-end">تكلفة الوحدة</th>
+                        <th class="text-end">إجمالي التكلفة</th>
+                      </tr>
+                    </thead>
+                    <tbody>
+                      <tr v-for="(dep, di) in item.depletions" :key="di">
+                        <td>{{ dep.batchNumber ?? '—' }}</td>
+                        <td>
+                          <v-chip
+                            v-if="dep.expiryDate"
+                            size="x-small"
+                            variant="tonal"
+                            :color="isExpiringSoon(dep.expiryDate) ? 'error' : 'grey'"
+                          >
+                            {{ dep.expiryDate }}
+                          </v-chip>
+                          <span v-else>—</span>
+                        </td>
+                        <td class="text-center">{{ dep.quantity }}</td>
+                        <td class="text-end">{{ formatAmount(dep.costPerUnit ?? 0) }}</td>
+                        <td class="text-end font-weight-medium">
+                          {{
+                            formatAmount(Math.round((dep.quantity ?? 0) * (dep.costPerUnit ?? 0)))
+                          }}
+                        </td>
+                      </tr>
+                    </tbody>
+                  </v-table>
+                  <div v-else class="text-caption text-medium-emphasis">
+                    لا توجد تفاصيل دفعات — قد لا يكون المنتج يتتبع الدفعات
+                  </div>
+                </td>
+              </template>
               <template #bottom>
                 <div class="d-flex justify-space-between pa-4 font-weight-bold">
                   <span>{{ t('sales.total') }}</span>
@@ -160,6 +203,35 @@
             />
           </v-card-text>
         </v-card>
+
+        <!-- COGS Summary (server-computed) -->
+        <v-card v-if="sale.cogs != null" class="win-card mt-4" flat>
+          <v-card-title class="pa-4 text-body-1 font-weight-bold"> ملخص التكلفة </v-card-title>
+          <v-card-text>
+            <v-row dense>
+              <v-col cols="6" sm="3">
+                <div class="text-caption text-medium-emphasis">تكلفة البضاعة المباعة</div>
+                <div class="text-body-1 font-weight-bold">{{ formatAmount(sale.cogs) }}</div>
+              </v-col>
+              <v-col cols="6" sm="3">
+                <div class="text-caption text-medium-emphasis">هامش الربح</div>
+                <div class="text-body-1 font-weight-bold text-success">
+                  {{ formatAmount(sale.total - (sale.cogs ?? 0)) }}
+                </div>
+              </v-col>
+            </v-row>
+          </v-card-text>
+        </v-card>
+
+        <!-- Audit Trail -->
+        <v-card class="win-card mt-4" flat>
+          <AuditLogTab
+            v-if="sale?.id"
+            entity-type="sale"
+            :entity-id="sale.id"
+            title="سجل تدقيق الفاتورة"
+          />
+        </v-card>
       </template>
     </div>
   </v-container>
@@ -171,6 +243,7 @@ import { useRoute } from 'vue-router';
 import { mapErrorToArabic, t } from '../../i18n/t';
 import { useSalesStore } from '../../stores/salesStore';
 import EmptyState from '../../components/emptyState.vue';
+import AuditLogTab from '../../components/shared/AuditLogTab.vue';
 import type { Sale } from '../../types/domain';
 
 const store = useSalesStore();
@@ -220,9 +293,14 @@ function statusIcon(status: string): string {
 
 function formatAmount(value: number): string {
   return new Intl.NumberFormat('ar-IQ', {
-    minimumFractionDigits: 2,
-    maximumFractionDigits: 2,
-  }).format(value);
+    minimumFractionDigits: 0,
+    maximumFractionDigits: 0,
+  }).format(Math.round(value));
+}
+
+function isExpiringSoon(dateStr: string): boolean {
+  const diff = new Date(dateStr).getTime() - Date.now();
+  return diff < 30 * 24 * 60 * 60 * 1000;
 }
 
 async function loadSale() {
diff --git a/apps/ui/src/views/sales/SaleFormView.vue b/apps/ui/src/views/sales/SaleFormView.vue
index f7211b3..ee43c2c 100644
--- a/apps/ui/src/views/sales/SaleFormView.vue
+++ b/apps/ui/src/views/sales/SaleFormView.vue
@@ -9,6 +9,20 @@
         <v-alert v-if="localizedError" type="error" variant="tonal" class="mb-4">
           {{ localizedError }}
         </v-alert>
+
+        <!-- Stock warnings for items with insufficient stock -->
+        <v-alert
+          v-for="warn in stockWarnings"
+          :key="warn.productId"
+          type="warning"
+          variant="tonal"
+          class="mb-2"
+          density="compact"
+        >
+          {{ warn.productName }}: المخزون المتاح {{ warn.available }} — الكمية المطلوبة
+          {{ warn.requested }}
+        </v-alert>
+
         <v-form class="win-form" @submit.prevent="submit">
           <div class="d-flex flex-wrap ga-2">
             <v-text-field v-model="form.invoiceNumber" :label="t('sales.invoice')" required />
@@ -54,6 +68,7 @@
                 type="number"
                 density="compact"
                 hide-details
+                @update:model-value="checkStockForItem(item)"
               />
             </template>
             <template #item.unitPrice="{ item }">
@@ -63,7 +78,7 @@
               <MoneyInput v-model="item.discount" density="compact" hide-details />
             </template>
             <template #item.subtotal="{ item }">
-              {{ formatAmount(itemSubtotal(item)) }}
+              {{ formatMoney(itemSubtotal(item)) }}
             </template>
             <template #item.actions="{ item }">
               <v-btn
@@ -79,8 +94,8 @@
 
           <v-divider class="my-4" />
           <div class="d-flex justify-end ga-4">
-            <div>{{ t('sales.subtotal') }}: {{ formatAmount(subtotal) }}</div>
-            <div>{{ t('sales.total') }}: {{ formatAmount(total) }}</div>
+            <div>{{ t('sales.subtotal') }}: {{ formatMoney(displaySubtotal) }}</div>
+            <div>{{ t('sales.total') }}: {{ formatMoney(displayTotal) }}</div>
           </div>
 
           <v-textarea v-model="form.notes" :label="t('common.notes')" rows="3" class="mt-4" />
@@ -92,6 +107,7 @@
               variant="flat"
               class="win-btn"
               :loading="store.loading"
+              :disabled="hasStockWarnings"
             >
               {{ t('sales.create') }}
             </v-btn>
@@ -111,18 +127,62 @@ import { useSalesStore } from '../../stores/salesStore';
 import { useProductsStore } from '../../stores/productsStore';
 import { useGlobalBarcodeScanner } from '../../composables/useGlobalBarcodeScanner';
 import { useCurrency } from '../../composables/useCurrency';
+import { productsClient } from '../../ipc';
 import MoneyInput from '@/components/shared/MoneyInput.vue';
 import type { SaleInput, SaleItem, Product } from '../../types/domain';
 
 const store = useSalesStore();
 const productsStore = useProductsStore();
 const router = useRouter();
-const { currency } = useCurrency();
+const { currency, formatMoney } = useCurrency();
 
 const localizedError = computed(() =>
   store.error ? mapErrorToArabic(store.error, 'errors.saveFailed') : null
 );
 
+// ──── Stock availability cache (fetched from server) ────
+const stockCache = ref<Map<number, number>>(new Map());
+const stockWarnings = computed(() => {
+  const warnings: {
+    productId: number;
+    productName: string;
+    available: number;
+    requested: number;
+  }[] = [];
+  for (const item of items.value) {
+    if (!item.productId) continue;
+    const available = stockCache.value.get(item.productId) ?? Infinity;
+    if (item.quantity > available) {
+      warnings.push({
+        productId: item.productId,
+        productName: item.productName ?? '',
+        available,
+        requested: item.quantity,
+      });
+    }
+  }
+  return warnings;
+});
+const hasStockWarnings = computed(() => stockWarnings.value.length > 0);
+
+async function fetchStockForProduct(productId: number): Promise<void> {
+  if (stockCache.value.has(productId)) return;
+  const batchesResult = await productsClient.getBatches(productId);
+  if (batchesResult.ok) {
+    const totalOnHand = batchesResult.data.reduce(
+      (sum: number, b: any) => sum + (b.quantityOnHand ?? 0),
+      0
+    );
+    stockCache.value.set(productId, totalOnHand);
+  }
+}
+
+function checkStockForItem(item: SaleItem): void {
+  if (item.productId) {
+    void fetchStockForProduct(item.productId);
+  }
+}
+
 // Barcode Scanner Integration
 const { start, stop } = useGlobalBarcodeScanner({
   mode: 'pos',
@@ -146,7 +206,6 @@ function addItemToCart(product: Product) {
   const existingItem = items.value.find((i) => i.productId === product.id);
   if (existingItem) {
     existingItem.quantity += 1;
-    existingItem.subtotal = itemSubtotal(existingItem);
   } else {
     items.value.push({
       productId: product.id!,
@@ -154,11 +213,13 @@ function addItemToCart(product: Product) {
       quantity: 1,
       unitPrice: product.sellingPrice,
       discount: 0,
-      subtotal: product.sellingPrice,
+      subtotal: 0,
       unitName: product.unit || 'pcs',
       unitFactor: 1,
     });
   }
+  // Pre-fetch stock info
+  void fetchStockForProduct(product.id!);
 }
 
 const itemHeaders = computed(() => [
@@ -199,20 +260,14 @@ const items = ref<SaleItem[]>([
   },
 ]);
 
+// Display-only subtotal/total — server computes final COGS and totals
 const itemSubtotal = (item: SaleItem) =>
-  Math.max(0, item.quantity * item.unitPrice - (item.discount || 0));
+  Math.round(Math.max(0, item.quantity * item.unitPrice - (item.discount || 0)));
 
-const subtotal = computed(() =>
+const displaySubtotal = computed(() =>
   items.value.reduce((sum: number, item: SaleItem) => sum + itemSubtotal(item), 0)
 );
-const total = computed(() => subtotal.value - form.discount + form.tax);
-
-function formatAmount(value: number): string {
-  return new Intl.NumberFormat('ar-IQ', {
-    minimumFractionDigits: 2,
-    maximumFractionDigits: 2,
-  }).format(value);
-}
+const displayTotal = computed(() => Math.round(displaySubtotal.value - form.discount + form.tax));
 
 function addItem() {
   items.value.push({
@@ -232,25 +287,34 @@ function removeItem(index: number) {
 }
 
 async function submit() {
+  // Send minimal payload — server handles FIFO depletion, COGS, totals, batch allocation
   const payload: SaleInput = {
     invoiceNumber: form.invoiceNumber,
     customerId: form.customerId,
-    subtotal: subtotal.value,
+    // Server computes authoritative subtotal/total — send 0 so backend overrides
+    subtotal: 0,
     discount: form.discount,
     tax: form.tax,
-    total: total.value,
+    total: 0,
     currency: form.currency,
     exchangeRate: 1,
     interestRate: 0,
     interestAmount: 0,
     paymentType: form.paymentType,
     paidAmount: form.paidAmount,
-    remainingAmount: total.value - form.paidAmount,
+    remainingAmount: 0,
     status: 'pending',
     notes: form.notes,
+    // Items: NO batchId — server assigns via FIFO; NO client subtotal
     items: items.value.map((item: SaleItem) => ({
-      ...item,
-      subtotal: itemSubtotal(item),
+      productId: item.productId,
+      productName: item.productName,
+      quantity: item.quantity,
+      unitPrice: item.unitPrice,
+      discount: item.discount || 0,
+      subtotal: 0, // server computes
+      unitName: item.unitName,
+      unitFactor: item.unitFactor,
     })),
   };
 
diff --git a/apps/ui/src/views/sales/SalesListView.vue b/apps/ui/src/views/sales/SalesListView.vue
index 9fa8af8..12c6c42 100644
--- a/apps/ui/src/views/sales/SalesListView.vue
+++ b/apps/ui/src/views/sales/SalesListView.vue
@@ -161,8 +161,8 @@ function statusBadgeClass(status: string): string {
 
 function formatAmount(value: number): string {
   return new Intl.NumberFormat('ar-IQ', {
-    minimumFractionDigits: 2,
-    maximumFractionDigits: 2,
+    minimumFractionDigits: 0,
+    maximumFractionDigits: 0,
   }).format(value);
 }
 
diff --git a/apps/ui/src/views/settings/SettingsView.vue b/apps/ui/src/views/settings/SettingsView.vue
index bd07bef..83205b1 100644
--- a/apps/ui/src/views/settings/SettingsView.vue
+++ b/apps/ui/src/views/settings/SettingsView.vue
@@ -1,256 +1,145 @@
 ﻿<template>
   <v-container>
     <div class="win-page">
-      <v-app-bar>
+      <v-app-bar class="ds-page-header d-flex align-center justify-space-between mb-6">
         <v-app-bar-title>
           <div class="win-title mb-0">{{ t('settings.title') }}</div>
           <div class="text-sm">{{ t('settings.subtitle') }}</div>
         </v-app-bar-title>
-
-        <template #append>
-          <v-btn color="primary" @click="loadCompanySettings" prepend-icon="mdi-refresh">
-            {{ t('common.refresh') }}
-          </v-btn>
-        </template>
       </v-app-bar>
 
-      <!-- Company Information Section -->
-      <v-card class="win-card win-card--padded mb-4" flat>
-        <v-alert v-if="localizedError" type="error" variant="tonal" class="mb-4">
-          {{ localizedError }}
-        </v-alert>
-
-        <v-card class="pa-4">
-          <v-card-title class="flex items-center justify-between mb-4">
-            <span>{{ t('settings.companyInfo') }}</span>
-          </v-card-title>
-
-          <v-form @submit.prevent="saveCompanySettings">
-            <v-row>
-              <v-col cols="12" md="6">
-                <v-text-field
-                  v-model="companyForm.name"
-                  :label="t('settings.companyName') + ' *'"
-                  variant="outlined"
-                  density="comfortable"
-                  required
-                />
-              </v-col>
-              <v-col cols="12" md="6">
-                <v-text-field
-                  v-model="companyForm.email"
-                  :label="t('settings.companyEmail')"
-                  variant="outlined"
-                  density="comfortable"
-                  type="email"
-                />
-              </v-col>
-              <v-col cols="12" md="6">
-                <v-text-field
-                  v-model="companyForm.phone"
-                  :label="t('settings.companyPhone')"
-                  variant="outlined"
-                  density="comfortable"
-                />
-              </v-col>
-              <v-col cols="12" md="6">
-                <v-text-field
-                  v-model="companyForm.phone2"
-                  :label="t('settings.companyPhone2')"
-                  variant="outlined"
-                  density="comfortable"
-                />
-              </v-col>
-              <v-col cols="12">
-                <v-textarea
-                  v-model="companyForm.address"
-                  :label="t('settings.companyAddress')"
-                  variant="outlined"
-                  density="comfortable"
-                  rows="2"
-                />
-              </v-col>
-              <v-col cols="12" md="6">
-                <v-text-field
-                  v-model="companyForm.taxId"
-                  :label="t('settings.companyTaxId')"
-                  variant="outlined"
-                  density="comfortable"
-                />
-              </v-col>
-              <v-col cols="12" md="6">
-                <v-select
-                  v-model="companyForm.currency"
-                  :items="currencyOptions"
-                  :label="t('settings.companyCurrency') + ' *'"
-                  variant="outlined"
-                  density="comfortable"
-                  required
-                />
-              </v-col>
-              <v-col cols="12" md="6">
-                <v-text-field
-                  v-model.number="companyForm.lowStockThreshold"
-                  :label="t('settings.lowStockThreshold')"
-                  variant="outlined"
-                  density="comfortable"
-                  type="number"
-                  min="0"
-                  :hint="t('settings.lowStockThresholdHint')"
-                  persistent-hint
-                />
-              </v-col>
-
-              <!-- select printer / the printer saved only in pinia store and localstorage no need to save it in db -->
-              <v-col cols="12" md="6">
-                <v-select
-                  v-model="selectedPrinter"
-                  :items="printers"
-                  item-title="name"
-                  item-value="name"
-                  :label="t('settings.receiptPrinter')"
-                  variant="outlined"
-                  density="comfortable"
-                  clearable
-                  @update:model-value="saveSelectedPrinter"
-                >
-                  <template #item="{ props, item }">
-                    <v-list-item v-bind="props">
-                      <template #append>
-                        <v-chip v-if="item.raw.isDefault" size="x-small" color="primary">
-                          {{ t('settings.default') }}
-                        </v-chip>
-                      </template>
-                    </v-list-item>
-                  </template>
-                </v-select>
-              </v-col>
-            </v-row>
-
-            <v-btn
-              type="submit"
-              color="primary"
-              variant="flat"
-              class="win-btn mt-4"
-              :loading="savingCompany"
-            >
-              {{ t('common.save') }}
-            </v-btn>
-          </v-form>
-        </v-card>
+      <v-card class="win-card" flat>
+        <v-tabs v-model="activeTab" color="primary">
+          <v-tab value="system">إعدادات النظام</v-tab>
+          <v-tab value="pos">نقطة البيع</v-tab>
+          <v-tab value="accounting">المحاسبة</v-tab>
+          <v-tab value="barcode">الباركود</v-tab>
+          <v-tab v-if="canManageUsers" value="users">المستخدمين</v-tab>
+        </v-tabs>
+
+        <v-divider />
+
+        <v-window v-model="activeTab">
+          <v-window-item value="system">
+            <v-card-text>
+              <SystemSettingsTab />
+            </v-card-text>
+          </v-window-item>
+
+          <v-window-item value="pos">
+            <v-card-text>
+              <PosSettingsTab />
+            </v-card-text>
+          </v-window-item>
+
+          <v-window-item value="accounting">
+            <v-card-text>
+              <AccountingSettingsTab />
+            </v-card-text>
+          </v-window-item>
+
+          <v-window-item value="barcode">
+            <v-card-text>
+              <BarcodeSettingsTab />
+            </v-card-text>
+          </v-window-item>
+
+          <v-window-item v-if="canManageUsers" value="users">
+            <v-card-text>
+              <UsersTab />
+            </v-card-text>
+          </v-window-item>
+        </v-window>
       </v-card>
     </div>
   </v-container>
 </template>
 
 <script setup lang="ts">
-import { computed, onMounted, reactive, ref, watch } from 'vue';
-import { mapErrorToArabic, t } from '../../i18n/t';
-import { useSettingsStore } from '../../stores/settingsStore';
-import { settingsClient } from '@/ipc/settingsClient';
-import type { SettingsCurrencyResponse, CompanySettings } from '../../types/domain';
-import type { Ref } from 'vue';
-
-const store = useSettingsStore();
-
-const localizedError = computed(() =>
-  store.error ? mapErrorToArabic(store.error, 'errors.unexpected') : null
-);
-
-const currency = ref<SettingsCurrencyResponse | null>(null);
-const savingCompany = ref(false);
-
-const companyForm = reactive<CompanySettings>({
-  name: '',
-  address: null,
-  phone: null,
-  phone2: null,
-  email: null,
-  taxId: null,
-  logo: null,
-  currency: 'USD',
-  lowStockThreshold: 5,
+import { computed, ref, watch } from 'vue';
+import { useRoute, useRouter } from 'vue-router';
+import { t } from '../../i18n/t';
+import { useAuthStore } from '../../stores/authStore';
+import * as uiAccess from '../../auth/uiAccess';
+import SystemSettingsTab from '@/components/settings/SystemSettingsTab.vue';
+import PosSettingsTab from '@/components/settings/PosSettingsTab.vue';
+import AccountingSettingsTab from '@/components/settings/AccountingSettingsTab.vue';
+import BarcodeSettingsTab from '@/components/settings/BarcodeSettingsTab.vue';
+import UsersTab from '@/components/settings/UsersTab.vue';
+
+type SettingsTab = 'system' | 'pos' | 'accounting' | 'barcode' | 'users';
+
+const route = useRoute();
+const router = useRouter();
+const authStore = useAuthStore();
+const activeTab = ref<SettingsTab>('system');
+
+const canManageUsers = computed(() => {
+  const role = authStore.user?.role;
+  if (!role) return false;
+  if (uiAccess.canManageUsers(role)) return true;
+
+  return authStore.permissions.some((permission) =>
+    ['users:read', 'users:create', 'users:update', 'users:delete'].includes(permission)
+  );
 });
 
-const currencyOptions: Ref<{ title: string; value: string }[]> = ref([
-  { title: 'USD - US Dollar', value: 'USD' },
-  { title: 'IQD - Iraqi Dinar', value: 'IQD' },
-  { title: 'EUR - Euro', value: 'EUR' },
-  { title: 'GBP - British Pound', value: 'GBP' },
-  { title: 'SAR - Saudi Riyal', value: 'SAR' },
-  { title: 'AED - UAE Dirham', value: 'AED' },
-  { title: 'EGP - Egyptian Pound', value: 'EGP' },
-  { title: 'JOD - Jordanian Dinar', value: 'JOD' },
-  { title: 'KWD - Kuwaiti Dinar', value: 'KWD' },
-]);
+const validTabs: SettingsTab[] = ['system', 'pos', 'accounting', 'barcode', 'users'];
 
-const printers: Ref<{ title: string; isDefault: boolean; value: string }[]> = ref([]);
-const selectedPrinter =
-  ref<string | null>(null) || JSON.parse(localStorage.getItem('selectedPrinter') || 'null');
-
-async function loadCurrency() {
-  const result = await store.fetchCurrencySettings();
-  if (result.ok) {
-    currency.value = result.data;
+function normalizeQueryTab(value: unknown): SettingsTab {
+  if (typeof value === 'string' && validTabs.includes(value as SettingsTab)) {
+    return value as SettingsTab;
   }
+  return 'system';
 }
 
-async function loadCompanySettings() {
-  try {
-    const result = await settingsClient.getCompany();
-    if (result.ok && result.data) {
-      Object.assign(companyForm, result.data);
-    }
-  } catch (err) {
-    console.error('Failed to load company settings:', err);
-  }
+function resolveAllowedTab(tab: SettingsTab): SettingsTab {
+  if (tab === 'users' && !canManageUsers.value) return 'system';
+  return tab;
 }
 
-async function saveCompanySettings() {
-  if (!companyForm.name) {
-    alert(t('settings.companyNameRequired'));
-    return;
+async function syncTabFromRoute(): Promise<void> {
+  const queryValue = Array.isArray(route.query.tab) ? route.query.tab[0] : route.query.tab;
+  const requestedTab = normalizeQueryTab(queryValue);
+  const allowedTab = resolveAllowedTab(requestedTab);
+
+  if (activeTab.value !== allowedTab) {
+    activeTab.value = allowedTab;
   }
 
-  savingCompany.value = true;
-  try {
-    console.log('Saving company settings:', companyForm);
-    const result = await settingsClient.setCompany(companyForm);
-    if (result.ok) {
-      alert(t('settings.companySaved'));
-    } else {
-      alert(result.error?.message || t('errors.unexpected'));
-    }
-  } catch (err) {
-    console.error('Failed to save company settings:', err);
-    alert(t('errors.unexpected'));
-  } finally {
-    savingCompany.value = false;
+  if (queryValue !== allowedTab) {
+    await router.replace({
+      query: {
+        ...route.query,
+        tab: allowedTab,
+      },
+    });
   }
 }
 
-async function loadPrinters() {
-  try {
-    const result: any = await store.fetchPrinters();
-    if (!result.ok) {
-      console.error('Failed to load printers:', result.error);
-    }
+watch(
+  [() => route.query.tab, canManageUsers],
+  () => {
+    void syncTabFromRoute();
+  },
+  { immediate: true }
+);
 
-    printers.value = result?.data?.printers || [];
-  } catch (err) {
-    console.error('Failed to load printers:', err);
+watch(activeTab, (tab) => {
+  const allowedTab = resolveAllowedTab(tab);
+  if (tab !== allowedTab) {
+    activeTab.value = allowedTab;
+    return;
   }
-}
 
-function saveSelectedPrinter() {
-  if (selectedPrinter.value) {
-    localStorage.setItem('selectedPrinter', JSON.stringify(selectedPrinter.value));
+  const queryValue = Array.isArray(route.query.tab) ? route.query.tab[0] : route.query.tab;
+  if (queryValue !== allowedTab) {
+    void router.replace({
+      query: {
+        ...route.query,
+        tab: allowedTab,
+      },
+    });
   }
-}
-
-onMounted(() => {
-  loadCompanySettings();
-  loadCurrency();
-  loadPrinters();
 });
 </script>
diff --git a/apps/ui/src/views/users/UsersView.vue b/apps/ui/src/views/users/UsersView.vue
index 0ce87d7..8309d64 100644
--- a/apps/ui/src/views/users/UsersView.vue
+++ b/apps/ui/src/views/users/UsersView.vue
@@ -1,7 +1,7 @@
 ﻿<template>
-  <v-container>
+  <v-container :fluid="props.embedded">
     <div class="win-page">
-      <v-app-bar class="ds-page-header d-flex align-center justify-space-between mb-6">
+      <v-app-bar v-if="!props.embedded" class="ds-page-header d-flex align-center justify-space-between mb-6">
         <v-app-bar-title>
           <div class="win-title mb-0">{{ t('users.title') }}</div>
           <div class="text-sm">{{ t('users.subtitle') }}</div>
@@ -18,6 +18,17 @@
           </v-btn>
         </template>
       </v-app-bar>
+      <div v-else class="d-flex justify-space-between align-center mb-4">
+        <div class="text-subtitle-1 font-weight-bold">{{ t('users.title') }}</div>
+        <v-btn
+          color="primary"
+          @click="openCreateDialog"
+          prepend-icon="mdi-plus"
+          :disabled="!canCreate"
+        >
+          {{ t('users.add') }}
+        </v-btn>
+      </div>
 
       <v-alert v-if="error" type="error" variant="tonal" class="mb-4">
         {{ error }}
@@ -115,6 +126,15 @@ import { usersClient } from '../../ipc';
 import { useAuthStore } from '../../stores/authStore';
 import type { UserInput, UserPublic, UserRole } from '../../types/domain';
 
+const props = withDefaults(
+  defineProps<{
+    embedded?: boolean;
+  }>(),
+  {
+    embedded: false,
+  }
+);
+
 const authStore = useAuthStore();
 
 const canCreate = computed(() => authStore.permissions.includes('users:create'));
diff --git a/packages/core/src/__tests__/CreatePurchaseUseCase.test.ts b/packages/core/src/__tests__/CreatePurchaseUseCase.test.ts
index 15f885d..7c3525c 100644
--- a/packages/core/src/__tests__/CreatePurchaseUseCase.test.ts
+++ b/packages/core/src/__tests__/CreatePurchaseUseCase.test.ts
@@ -38,17 +38,33 @@ class FakePurchaseRepository implements IPurchaseRepository {
     return this.items.find((item) => item.id === id) || null;
   }
 
+  findByIdSync(id: number): Purchase | null {
+    return this.items.find((item) => item.id === id) || null;
+  }
+
   async updateStatus(id: number, status: string): Promise<void> {
     const item = this.items.find((p) => p.id === id);
     if (item) item.status = status as any;
   }
 
+  updateStatusSync(id: number, status: string): void {
+    const item = this.items.find((p) => p.id === id);
+    if (item) item.status = status as any;
+  }
+
   async updatePayment(id: number, paidAmount: number, remainingAmount: number): Promise<void> {
     const item = this.items.find((p) => p.id === id);
     if (!item) return;
     item.paidAmount = paidAmount;
     item.remainingAmount = remainingAmount;
   }
+
+  updatePaymentSync(id: number, paidAmount: number, remainingAmount: number): void {
+    const item = this.items.find((p) => p.id === id);
+    if (!item) return;
+    item.paidAmount = paidAmount;
+    item.remainingAmount = remainingAmount;
+  }
 }
 
 class FakeSupplierRepository implements ISupplierRepository {
diff --git a/packages/core/src/__tests__/DomainErrors.test.ts b/packages/core/src/__tests__/DomainErrors.test.ts
index 2053f66..a05ae3f 100644
--- a/packages/core/src/__tests__/DomainErrors.test.ts
+++ b/packages/core/src/__tests__/DomainErrors.test.ts
@@ -17,7 +17,7 @@ import {
 describe('DomainErrors', () => {
   describe('DomainError (base)', () => {
     it('should create base domain error', () => {
-      const error = new DomainError('Test error message');
+      const error = new DomainError('DOMAIN_ERROR', 'Test error message');
       expect(error).toBeInstanceOf(Error);
       expect(error.message).toBe('Test error message');
       expect(error.code).toBe('DOMAIN_ERROR');
@@ -26,7 +26,7 @@ describe('DomainErrors', () => {
 
     it('should include details in error', () => {
       const details = { userId: 1, actionId: 42 };
-      const error = new DomainError('Test error', details);
+      const error = new DomainError('DOMAIN_ERROR', 'Test error', 400, details);
       expect(error.details).toEqual(details);
     });
   });
diff --git a/packages/core/src/__tests__/FullFlowIntegration.test.ts b/packages/core/src/__tests__/FullFlowIntegration.test.ts
index 81ae075..d9cd93b 100644
--- a/packages/core/src/__tests__/FullFlowIntegration.test.ts
+++ b/packages/core/src/__tests__/FullFlowIntegration.test.ts
@@ -1,430 +1,88 @@
-/**
- * Full Flow Integration Tests
- * Validates end-to-end flow from UI call through IPC to use case execution
- * Tests Phase 1-4 integration: real userId → typed errors → RBAC → audit logging
- */
-import { describe, it, expect, beforeEach } from 'vitest';
+﻿import { describe, it, expect } from 'vitest';
+import { CreateSaleUseCase, ValidationError } from '@nuqtaplus/core';
 import {
-  CreateSaleUseCase,
-  LoginUseCase,
-  PermissionService,
-  ValidationError,
-  PermissionDeniedError,
-} from '@nuqtaplus/core';
-import {
-  SqliteSaleRepository,
-  SqliteProductRepository,
-  SqliteCustomerRepository,
-  SqliteSettingsRepository,
-  SqlitePaymentRepository,
-  SqliteUserRepository,
-  SqliteAuditRepository,
-} from '@nuqtaplus/data';
-import {
-  createTestDb,
-  createTestProduct,
-  createTestUser,
-  createTestCurrencySettings,
-} from '@nuqtaplus/data';
-import * as bcrypt from 'bcrypt';
-
-describe('Full Flow Integration (Phase 1-4)', () => {
-  let db: any;
-  let saleRepo: SqliteSaleRepository;
-  let productRepo: SqliteProductRepository;
-  let customerRepo: SqliteCustomerRepository;
-  let settingsRepo: SqliteSettingsRepository;
-  let paymentRepo: SqlitePaymentRepository;
-  let userRepo: SqliteUserRepository;
-  let auditRepo: SqliteAuditRepository;
-  let loginUseCase: LoginUseCase;
-  let createSaleUseCase: CreateSaleUseCase;
-
-  beforeEach(async () => {
-    db = createTestDb();
-    saleRepo = new SqliteSaleRepository(db);
-    productRepo = new SqliteProductRepository(db);
-    customerRepo = new SqliteCustomerRepository(db);
-    settingsRepo = new SqliteSettingsRepository(db);
-    paymentRepo = new SqlitePaymentRepository(db);
-    userRepo = new SqliteUserRepository(db);
-    auditRepo = new SqliteAuditRepository(db);
-
-    loginUseCase = new LoginUseCase(userRepo);
-    createSaleUseCase = new CreateSaleUseCase(
+  FakeSaleRepository,
+  FakeProductRepository,
+  FakeCustomerRepository,
+  FakeSettingsRepository,
+  FakePaymentRepository,
+  FakeInventoryRepository,
+  FakeAccountingRepository,
+  FakeCustomerLedgerRepository,
+  FakeAuditRepository,
+} from './fakes';
+
+describe('FullFlowIntegration', () => {
+  it('creates a cash sale end-to-end through repositories', async () => {
+    const saleRepo = new FakeSaleRepository();
+    const productRepo = new FakeProductRepository();
+    const customerRepo = new FakeCustomerRepository();
+    const settingsRepo = new FakeSettingsRepository();
+    const paymentRepo = new FakePaymentRepository();
+    const inventoryRepo = new FakeInventoryRepository();
+    const accountingRepo = new FakeAccountingRepository();
+    const customerLedgerRepo = new FakeCustomerLedgerRepository();
+    const auditRepo = new FakeAuditRepository();
+
+    const useCase = new CreateSaleUseCase(
       saleRepo,
       productRepo,
       customerRepo,
       settingsRepo,
       paymentRepo,
+      inventoryRepo,
+      accountingRepo,
+      customerLedgerRepo,
       auditRepo
     );
 
-    // Setup test data
-    await createTestCurrencySettings(db);
-  });
-
-  describe('Phase 1: Real UserID Tracking', () => {
-    it('should persist userId throughout transaction', async () => {
-      // Create user (cashier role)
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      const user = await createTestUser(db, {
-        username: 'cashier1',
-        password: hashedPassword,
-        role: 'cashier',
-      });
-
-      // Login to get userId
-      const loginResult = await loginUseCase.execute({
-        username: 'cashier1',
-        password: 'password123',
-      });
-
-      expect(loginResult.user.id).toBe(user.id);
-
-      // Create product and sale
-      const product = await createTestProduct(db, { stock: 100 });
-
-      const sale = await createSaleUseCase.execute(
-        {
-          items: [{ productId: product.id, quantity: 5, unitPrice: 100 }],
-          paymentType: 'cash',
-          paidAmount: 500,
-        },
-        user.id! // Passing real userId
-      );
-
-      // Verify sale was created with correct userId
-      expect(sale.createdBy).toBe(user.id);
-    });
-  });
-
-  describe('Phase 2: Typed Error Handling', () => {
-    it('should throw ValidationError with typed response', async () => {
-      try {
-        await createSaleUseCase.execute(
-          {
-            items: [], // Will fail validation
-            paymentType: 'cash',
-          },
-          1
-        );
-        expect.fail('Should have thrown ValidationError');
-      } catch (error: any) {
-        expect(error).toBeInstanceOf(ValidationError);
-        expect(error.code).toBe('VALIDATION_ERROR');
-        expect(error.statusCode).toBe(400);
-      }
-    });
-
-    it('should throw InsufficientStockError with product details', async () => {
-      const product = await createTestProduct(db, { stock: 5, name: 'Widget' });
-
-      try {
-        await createSaleUseCase.execute(
-          {
-            items: [{ productId: product.id, quantity: 10, unitPrice: 100 }],
-            paymentType: 'cash',
-          },
-          1
-        );
-        expect.fail('Should have thrown InsufficientStockError');
-      } catch (error: any) {
-        expect(error.code).toBe('INSUFFICIENT_STOCK');
-        expect(error.statusCode).toBe(409);
-        expect(error.details.available).toBe(5);
-        expect(error.details.requested).toBe(10);
-      }
-    });
-
-    it('should throw NotFoundError for nonexistent product', async () => {
-      try {
-        await createSaleUseCase.execute(
-          {
-            items: [{ productId: 999, quantity: 1, unitPrice: 100 }],
-            paymentType: 'cash',
-          },
-          1
-        );
-        expect.fail('Should have thrown NotFoundError');
-      } catch (error: any) {
-        expect(error.code).toBe('NOT_FOUND');
-        expect(error.statusCode).toBe(404);
-      }
-    });
-  });
-
-  describe('Phase 3: RBAC Permission Checks', () => {
-    it('should allow cashier to create sales', async () => {
-      const product = await createTestProduct(db, { stock: 100 });
-
-      // Simulate IPC handler permission check
-      const userRole = 'cashier';
-      const hasPermission = PermissionService.hasPermission(userRole, 'sales:create');
-      expect(hasPermission).toBe(true);
-
-      // Should succeed
-      const sale = await createSaleUseCase.execute(
-        {
-          items: [{ productId: product.id, quantity: 5, unitPrice: 100 }],
-          paymentType: 'cash',
-          paidAmount: 500,
-        },
-        1
-      );
-
-      expect(sale.id).toBeDefined();
-    });
-
-    it('should deny viewer from creating sales', () => {
-      const userRole = 'viewer';
-      const hasPermission = PermissionService.hasPermission(userRole, 'sales:create');
-      expect(hasPermission).toBe(false);
-    });
-
-    it('should allow manager to read but not create products', () => {
-      const managerRole = 'manager';
-      expect(PermissionService.hasPermission(managerRole, 'products:read')).toBe(true);
-      expect(PermissionService.hasPermission(managerRole, 'products:create')).toBe(false);
-    });
-
-    it('should allow admin all permissions', () => {
-      const adminRole = 'admin';
-      const allPermissions = PermissionService.getAllPermissions();
+    const product = productRepo.create({
+      name: 'Notebook',
+      sku: 'NB-001',
+      costPrice: 1000,
+      sellingPrice: 1500,
+      stock: 20,
+      currency: 'IQD',
+      isActive: true,
+    } as any);
+
+    const sale = await useCase.execute(
+      {
+        items: [{ productId: product.id!, quantity: 2, unitPrice: 1500 }],
+        paymentType: 'cash',
+        paidAmount: 3000,
+      },
+      1
+    );
 
-      allPermissions.forEach((permission) => {
-        expect(PermissionService.hasPermission(adminRole, permission)).toBe(true);
-      });
-    });
+    expect(sale.id).toBeDefined();
+    expect(sale.status).toBe('completed');
+    expect(inventoryRepo.movements.length).toBe(1);
+    expect(productRepo.findById(product.id!)?.stock).toBe(18);
   });
 
-  describe('Phase 4: Audit Logging Integration', () => {
-    it('should log sale creation automatically', async () => {
-      const product = await createTestProduct(db, { stock: 100 });
-
-      const sale = await createSaleUseCase.execute(
-        {
-          items: [{ productId: product.id, quantity: 5, unitPrice: 100 }],
-          paymentType: 'cash',
-          paidAmount: 500,
-        },
-        1
-      );
-
-      // Verify audit entry was created
-      const auditEvents = await auditRepo.getByFilters({
-        entityType: 'Sale',
-        entityId: sale.id,
-      });
-
-      expect(auditEvents.length).toBeGreaterThan(0);
-      const event = auditEvents[0];
-      expect(event.action).toBe('sales:create');
-      expect(event.userId).toBe(1);
-      expect(event.entityId).toBe(sale.id);
-    });
-
-    it('should include sale details in audit log', async () => {
-      const product = await createTestProduct(db, { stock: 100 });
-
-      const sale = await createSaleUseCase.execute(
-        {
-          items: [{ productId: product.id, quantity: 5, unitPrice: 100 }],
-          paymentType: 'cash',
-          paidAmount: 500,
-        },
-        1
-      );
-
-      const auditEvents = await auditRepo.getByFilters({
-        entityType: 'Sale',
-        entityId: sale.id,
-      });
-
-      const event = auditEvents[0];
-      expect(event.changeDescription).toContain(sale.invoiceNumber);
-      expect(event.changeDescription).toContain(sale.total.toString());
-    });
-
-    it('should track user who created sale', async () => {
-      const hashedPassword = await bcrypt.hash('pass', 10);
-      const manager = await createTestUser(db, {
-        username: 'manager1',
-        password: hashedPassword,
-        role: 'manager',
-      });
-
-      const product = await createTestProduct(db, { stock: 100 });
-
-      const sale = await createSaleUseCase.execute(
-        {
-          items: [{ productId: product.id, quantity: 2, unitPrice: 50 }],
-          paymentType: 'cash',
-          paidAmount: 100,
-        },
-        manager.id! // Different user
-      );
-
-      const auditEvents = await auditRepo.getByFilters({
-        entityType: 'Sale',
-        entityId: sale.id,
-      });
-
-      expect(auditEvents[0].userId).toBe(manager.id);
-    });
-
-    it('should record audit trail for entity', async () => {
-      const product = await createTestProduct(db, { stock: 100 });
+  it('throws typed validation error for empty sale items', async () => {
+    const useCase = new CreateSaleUseCase(
+      new FakeSaleRepository(),
+      new FakeProductRepository(),
+      new FakeCustomerRepository(),
+      new FakeSettingsRepository(),
+      new FakePaymentRepository(),
+      new FakeInventoryRepository(),
+      new FakeAccountingRepository(),
+      new FakeCustomerLedgerRepository(),
+      new FakeAuditRepository()
+    );
 
-      // Create sale
-      const sale = await createSaleUseCase.execute(
+    await expect(
+      useCase.execute(
         {
-          items: [{ productId: product.id, quantity: 5, unitPrice: 100 }],
+          items: [],
           paymentType: 'cash',
-          paidAmount: 500,
         },
         1
-      );
-
-      // Get full audit trail for this sale
-      const trail = await auditRepo.getAuditTrail('Sale', sale.id!);
-
-      expect(trail.length).toBeGreaterThan(0);
-      expect(trail.some((e) => e.action === 'sales:create')).toBe(true);
-    });
-  });
-
-  describe('Cross-Phase Integration Scenarios', () => {
-    it('should handle complete workflow: login → create sale → audit log', async () => {
-      // Phase 1+2+3+4 integration
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      const user = await createTestUser(db, {
-        username: 'integration_test',
-        password: hashedPassword,
-        role: 'cashier',
-      });
-
-      // Login
-      const loginResult = await loginUseCase.execute({
-        username: 'integration_test',
-        password: 'password123',
-      });
-
-      // Verify permissions are loaded
-      expect(loginResult.permissions).toContain('sales:create');
-      expect(loginResult.permissions).not.toContain('users:create');
-
-      // Create product
-      const product = await createTestProduct(db, { stock: 100 });
-
-      // Create sale with authenticated userId
-      const sale = await createSaleUseCase.execute(
-        {
-          items: [{ productId: product.id, quantity: 10, unitPrice: 100 }],
-          paymentType: 'cash',
-          paidAmount: 1000,
-        },
-        loginResult.user.id!
-      );
-
-      // Verify complete flow
-      expect(sale.id).toBeDefined();
-      expect(sale.createdBy).toBe(loginResult.user.id);
-
-      // Verify audit trail
-      const auditTrail = await auditRepo.getAuditTrail('Sale', sale.id!);
-      expect(auditTrail.length).toBeGreaterThan(0);
-      expect(auditTrail[0].userId).toBe(loginResult.user.id);
-    });
-
-    it('should prevent unauthorized action (permission denied)', async () => {
-      // Phase 3 enforces before Phase 2 error mapping
-      const product = await createTestProduct(db, { stock: 100 });
-
-      // Check viewer cannot create sale
-      const viewerRole = 'viewer';
-      const hasPermission = PermissionService.hasPermission(viewerRole, 'sales:create');
-
-      expect(hasPermission).toBe(false);
-
-      // In actual IPC handler, PermissionDeniedError would be thrown here
-      // This demonstrates the permission guard prevents execution before use case
-    });
-
-    it('should include error details in IPC response', async () => {
-      // Phase 2 error mapping
-      const product = await createTestProduct(db, {
-        name: 'Scarce Item',
-        stock: 2,
-      });
-
-      try {
-        await createSaleUseCase.execute(
-          {
-            items: [{ productId: product.id, quantity: 10, unitPrice: 100 }],
-            paymentType: 'cash',
-          },
-          1
-        );
-        expect.fail('Should throw error');
-      } catch (error: any) {
-        // This error would be mapped by IpcErrorMapperService in real flow
-        const ipcResponse = {
-          error: error.message,
-          code: error.code,
-          statusCode: error.statusCode,
-          details: error.details,
-        };
-
-        expect(ipcResponse.code).toBe('INSUFFICIENT_STOCK');
-        expect(ipcResponse.statusCode).toBe(409);
-        expect(ipcResponse.details.available).toBe(2);
-        expect(ipcResponse.details.requested).toBe(10);
-      }
-    });
-  });
-
-  describe('Error Recovery and Consistency', () => {
-    it('should maintain data consistency on validation error', async () => {
-      const product = await createTestProduct(db, { stock: 100 });
-      const initialStock = product.stock;
-
-      try {
-        await createSaleUseCase.execute(
-          {
-            items: [
-              { productId: product.id, quantity: 150, unitPrice: 100 }, // Fails
-            ],
-            paymentType: 'cash',
-          },
-          1
-        );
-      } catch (error) {
-        // Error expected
-      }
-
-      // Stock should not change
-      const updatedProduct = await productRepo.findById(product.id);
-      expect(updatedProduct!.stock).toBe(initialStock);
-    });
-
-    it('should not create audit log on validation error', async () => {
-      const initialEvents = await auditRepo.getByFilters({});
-
-      try {
-        await createSaleUseCase.execute(
-          {
-            items: [], // Invalid
-            paymentType: 'cash',
-          },
-          1
-        );
-      } catch (error) {
-        // Expected
-      }
-
-      const finalEvents = await auditRepo.getByFilters({});
-      expect(finalEvents.length).toBe(initialEvents.length);
-    });
+      )
+    ).rejects.toThrow(ValidationError);
   });
 });
+
diff --git a/packages/core/src/__tests__/LoginUseCase.test.ts b/packages/core/src/__tests__/LoginUseCase.test.ts
index 9fd36fc..bd722e3 100644
--- a/packages/core/src/__tests__/LoginUseCase.test.ts
+++ b/packages/core/src/__tests__/LoginUseCase.test.ts
@@ -1,357 +1,124 @@
-/**
- * LoginUseCase Tests
- * Validates authentication flow, permission loading, and role handling
- */
-import { describe, it, expect, beforeEach } from 'vitest';
+﻿import { describe, it, expect, beforeEach } from 'vitest';
 import {
   LoginUseCase,
   ValidationError,
   UnauthorizedError,
   PermissionService,
 } from '@nuqtaplus/core';
-import { SqliteUserRepository } from '@nuqtaplus/data';
-import { createTestDb, createTestUser } from '@nuqtaplus/data';
-import * as bcrypt from 'bcrypt';
+import { hashPassword } from '../utils/helpers.js';
+import type { IUserRepository } from '../interfaces/IUserRepository.js';
+import type { User } from '../entities/User.js';
+
+class InMemoryUserRepository implements IUserRepository {
+  private users: User[] = [];
+  private nextId = 1;
+
+  findByUsername(username: string): User | null {
+    return this.users.find((u) => u.username === username) || null;
+  }
+
+  findById(id: number): User | null {
+    return this.users.find((u) => u.id === id) || null;
+  }
+
+  create(user: User): User {
+    const created = {
+      ...user,
+      id: user.id ?? this.nextId++,
+      createdAt: user.createdAt ?? new Date().toISOString(),
+      updatedAt: user.updatedAt ?? new Date().toISOString(),
+    };
+    this.users.push(created);
+    return created;
+  }
+
+  findAll(): User[] {
+    return [...this.users];
+  }
+
+  update(id: number, data: Partial<User>): User {
+    const idx = this.users.findIndex((u) => u.id === id);
+    if (idx < 0) throw new Error('User not found');
+    this.users[idx] = {
+      ...this.users[idx],
+      ...data,
+      updatedAt: new Date().toISOString(),
+    };
+    return this.users[idx];
+  }
+
+  count(): number {
+    return this.users.length;
+  }
+
+  updateLastLogin(id: number): void {
+    this.update(id, { lastLoginAt: new Date().toISOString() });
+  }
+}
 
 describe('LoginUseCase', () => {
-  let db: any;
-  let userRepo: SqliteUserRepository;
+  let userRepo: InMemoryUserRepository;
   let useCase: LoginUseCase;
 
-  beforeEach(async () => {
-    db = createTestDb();
-    userRepo = new SqliteUserRepository(db);
+  const seedUser = async (overrides: Partial<User> = {}): Promise<User> => {
+    const password = overrides.password ?? (await hashPassword('password123'));
+    return userRepo.create({
+      username: 'cashier',
+      password,
+      fullName: 'Cashier User',
+      role: 'cashier',
+      isActive: true,
+      phone: null,
+      lastLoginAt: null,
+      ...overrides,
+    });
+  };
+
+  beforeEach(() => {
+    userRepo = new InMemoryUserRepository();
     useCase = new LoginUseCase(userRepo);
   });
 
-  describe('Validation', () => {
-    it('should reject empty username', async () => {
-      await expect(
-        useCase.execute({
-          username: '',
-          password: 'password123',
-        })
-      ).rejects.toThrow(ValidationError);
-    });
-
-    it('should reject empty password', async () => {
-      await expect(
-        useCase.execute({
-          username: 'testuser',
-          password: '',
-        })
-      ).rejects.toThrow(ValidationError);
-    });
-
-    it('should reject both empty credentials', async () => {
-      await expect(
-        useCase.execute({
-          username: '',
-          password: '',
-        })
-      ).rejects.toThrow(ValidationError);
-    });
+  it('rejects empty username', async () => {
+    await expect(useCase.execute({ username: '', password: 'password123' })).rejects.toThrow(
+      UnauthorizedError
+    );
   });
 
-  describe('Authentication', () => {
-    it('should reject nonexistent user', async () => {
-      await expect(
-        useCase.execute({
-          username: 'nonexistent',
-          password: 'password123',
-        })
-      ).rejects.toThrow(UnauthorizedError);
-    });
-
-    it('should reject incorrect password', async () => {
-      const hashedPassword = await bcrypt.hash('correctpassword', 10);
-      await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-      });
-
-      await expect(
-        useCase.execute({
-          username: 'testuser',
-          password: 'wrongpassword',
-        })
-      ).rejects.toThrow(UnauthorizedError);
-    });
-
-    it('should reject inactive user', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'inactiveuser',
-        password: hashedPassword,
-        isActive: false,
-      });
-
-      await expect(
-        useCase.execute({
-          username: 'inactiveuser',
-          password: 'password123',
-        })
-      ).rejects.toThrow(UnauthorizedError);
-    });
-  });
-
-  describe('Successful Login', () => {
-    it('should return user on valid credentials', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      const testUser = await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-        fullName: 'Test User',
-        role: 'cashier',
-      });
-
-      const result = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      expect(result.user).toBeDefined();
-      expect(result.user.id).toBe(testUser.id);
-      expect(result.user.username).toBe('testuser');
-      expect(result.user.fullName).toBe('Test User');
-    });
-
-    it('should update last login timestamp', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      const testUser = await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-        lastLoginAt: null,
-      });
-
-      const result = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      expect(result.user.lastLoginAt).toBeDefined();
-      // Check that timestamp was updated (not null)
-      expect(result.user.lastLoginAt).not.toBeNull();
-    });
-
-    it('should return token on login', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-      });
-
-      const result = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      expect(result.token).toBeDefined();
-      expect(typeof result.token).toBe('string');
-      expect(result.token.length).toBeGreaterThan(0);
-    });
-  });
-
-  describe('Permissions Loading', () => {
-    it('should return permissions array for cashier role', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'cashier',
-        password: hashedPassword,
-        role: 'cashier',
-      });
-
-      const result = await useCase.execute({
-        username: 'cashier',
-        password: 'password123',
-      });
-
-      expect(Array.isArray(result.permissions)).toBe(true);
-      expect(result.permissions.length).toBeGreaterThan(0);
-      // Cashier should have sales:create
-      expect(result.permissions).toContain('sales:create');
-    });
-
-    it('should return more permissions for admin role', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-
-      const cashierUser = await createTestUser(db, {
-        username: 'cashier',
-        password: hashedPassword,
-        role: 'cashier',
-      });
-
-      const adminUser = await createTestUser(db, {
-        username: 'admin',
-        password: hashedPassword,
-        role: 'admin',
-      });
-
-      const cashierResult = await useCase.execute({
-        username: 'cashier',
-        password: 'password123',
-      });
-
-      const adminResult = await useCase.execute({
-        username: 'admin',
-        password: 'password123',
-      });
-
-      expect(adminResult.permissions.length).toBeGreaterThan(cashierResult.permissions.length);
-    });
-
-    it('should return viewer-only permissions for viewer role', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'viewer',
-        password: hashedPassword,
-        role: 'viewer',
-      });
-
-      const result = await useCase.execute({
-        username: 'viewer',
-        password: 'password123',
-      });
-
-      // Viewer should only have read permissions
-      const hasWriteOp = result.permissions.some(
-        (p) => p.includes('create') || p.includes('update') || p.includes('delete')
-      );
-
-      expect(hasWriteOp).toBe(false);
-      expect(result.permissions.some((p) => p.includes('read'))).toBe(true);
-    });
-
-    it('should return admin all permissions', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'admin',
-        password: hashedPassword,
-        role: 'admin',
-      });
-
-      const result = await useCase.execute({
-        username: 'admin',
-        password: 'password123',
-      });
-
-      const allPermissions = PermissionService.getAllPermissions();
-      expect(result.permissions.length).toBe(allPermissions.length);
-    });
-
-    it('should use PermissionService for consistent permission matrix', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'manager',
-        password: hashedPassword,
-        role: 'manager',
-      });
-
-      const result = await useCase.execute({
-        username: 'manager',
-        password: 'password123',
-      });
-
-      const expectedPermissions = PermissionService.getPermissionsForRole('manager');
-
-      expect(result.permissions).toEqual(expectedPermissions);
-    });
+  it('rejects empty password', async () => {
+    await expect(useCase.execute({ username: 'cashier', password: '' })).rejects.toThrow(
+      UnauthorizedError
+    );
   });
 
-  describe('Return Structure', () => {
-    it('should return complete login result', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-        role: 'cashier',
-      });
-
-      const result = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      expect(result).toHaveProperty('user');
-      expect(result).toHaveProperty('token');
-      expect(result).toHaveProperty('permissions');
-
-      expect(result.user).toHaveProperty('id');
-      expect(result.user).toHaveProperty('username');
-      expect(result.user).toHaveProperty('fullName');
-      expect(result.user).toHaveProperty('role');
-    });
-
-    it('should not return password in user object', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-      });
-
-      const result = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      expect((result.user as any).password).toBeUndefined();
-    });
+  it('rejects unknown username', async () => {
+    await expect(
+      useCase.execute({ username: 'missing-user', password: 'password123' })
+    ).rejects.toThrow(UnauthorizedError);
   });
 
-  describe('Multiple Login Attempts', () => {
-    it('should allow repeated logins', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'testuser',
-        password: hashedPassword,
-      });
-
-      const result1 = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      const result2 = await useCase.execute({
-        username: 'testuser',
-        password: 'password123',
-      });
-
-      expect(result1.user.id).toBe(result2.user.id);
-      // Tokens should be different (new token on each login)
-      expect(result1.token).not.toBe(result2.token);
-    });
+  it('rejects inactive users', async () => {
+    await seedUser({ username: 'inactive', isActive: false });
+    await expect(
+      useCase.execute({ username: 'inactive', password: 'password123' })
+    ).rejects.toThrow(ValidationError);
   });
 
-  describe('Edge Cases', () => {
-    it('should handle username with special characters', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'user@domain.com',
-        password: hashedPassword,
-      });
-
-      const result = await useCase.execute({
-        username: 'user@domain.com',
-        password: 'password123',
-      });
+  it('returns user + permissions and updates last login', async () => {
+    const seeded = await seedUser({ username: 'manager', role: 'manager' });
 
-      expect(result.user.username).toBe('user@domain.com');
+    const result = await useCase.execute({
+      username: 'manager',
+      password: 'password123',
     });
 
-    it('should be case-sensitive for username', async () => {
-      const hashedPassword = await bcrypt.hash('password123', 10);
-      await createTestUser(db, {
-        username: 'TestUser',
-        password: hashedPassword,
-      });
+    expect(result.user.id).toBe(seeded.id);
+    expect(result.user.username).toBe('manager');
+    expect((result.user as any).password).toBeUndefined();
+    expect(result.permissions).toEqual(PermissionService.getPermissionsForRole('manager'));
 
-      // Assuming case-sensitive username
-      await expect(
-        useCase.execute({
-          username: 'testuser',
-          password: 'password123',
-        })
-      ).rejects.toThrow(UnauthorizedError);
-    });
+    const updated = userRepo.findById(seeded.id!);
+    expect(updated?.lastLoginAt).toBeDefined();
   });
 });
+
diff --git a/packages/core/src/entities/Accounting.ts b/packages/core/src/entities/Accounting.ts
index a4ba937..47986c1 100644
--- a/packages/core/src/entities/Accounting.ts
+++ b/packages/core/src/entities/Accounting.ts
@@ -33,6 +33,7 @@ export const JournalEntrySchema = z.object({
   isPosted: z.boolean().default(true),
   isReversed: z.boolean().default(false),
   reversalOfId: z.number().optional(),
+  postingBatchId: z.number().nullable().optional(),
   totalAmount: z.number().int().min(0),
   currency: z.string().default('IQD'),
   notes: z.string().nullable().optional(),
diff --git a/packages/core/src/index.ts b/packages/core/src/index.ts
index dcbe5c8..8e81035 100644
--- a/packages/core/src/index.ts
+++ b/packages/core/src/index.ts
@@ -22,6 +22,8 @@ export * from './errors/DomainErrors.js';
 export * from './services/PermissionService.js';
 export * from './services/AuditService.js';
 export * from './services/JwtService.js';
+export * from './services/FifoDepletionService.js';
+export * from './services/SettingsAccessor.js';
 
 export * from './interfaces/ICategoryRepository.js';
 export * from './interfaces/ICustomerRepository.js';
@@ -103,3 +105,15 @@ export * from './interfaces/ISupplierLedgerRepository.js';
 export * from './use-cases/supplier-ledger/GetSupplierLedgerUseCase.js';
 export * from './use-cases/supplier-ledger/RecordSupplierPaymentUseCase.js';
 export * from './use-cases/supplier-ledger/ReconcileSupplierBalanceUseCase.js';
+
+// ── Module Settings + Setup Wizard ──
+export * from './entities/ModuleSettings.js';
+export * from './entities/PostingBatch.js';
+export * from './interfaces/IPostingRepository.js';
+export * from './use-cases/GetModuleSettingsUseCase.js';
+export * from './use-cases/CompleteSetupWizardUseCase.js';
+export * from './use-cases/AddPurchasePaymentUseCase.js';
+
+// ── Posting ──
+export * from './use-cases/posting/PostPeriodUseCase.js';
+export * from './use-cases/posting/ReverseEntryUseCase.js';
diff --git a/packages/core/src/interfaces/IPurchaseRepository.ts b/packages/core/src/interfaces/IPurchaseRepository.ts
index de0b668..1a16429 100644
--- a/packages/core/src/interfaces/IPurchaseRepository.ts
+++ b/packages/core/src/interfaces/IPurchaseRepository.ts
@@ -14,6 +14,9 @@ export interface IPurchaseRepository {
     offset?: number;
   }): Promise<{ items: Purchase[]; total: number }>;
   findById(id: number): Promise<Purchase | null>;
+  findByIdSync?(id: number): Purchase | null;
   updateStatus(id: number, status: string): Promise<void>;
+  updateStatusSync?(id: number, status: string): void;
   updatePayment(id: number, paidAmount: number, remainingAmount: number): Promise<void>;
+  updatePaymentSync?(id: number, paidAmount: number, remainingAmount: number): void;
 }
diff --git a/packages/core/src/use-cases/AddPaymentUseCase.ts b/packages/core/src/use-cases/AddPaymentUseCase.ts
index 6eeb308..f75f9bd 100644
--- a/packages/core/src/use-cases/AddPaymentUseCase.ts
+++ b/packages/core/src/use-cases/AddPaymentUseCase.ts
@@ -9,6 +9,7 @@ import { roundByCurrency } from '../utils/helpers.js';
 import { Sale } from '../entities/Sale.js';
 import type { PaymentMethod } from '../entities/Payment.js';
 import type { JournalLine } from '../entities/Accounting.js';
+import { MODULE_SETTING_KEYS } from '../entities/ModuleSettings.js';
 
 const ACCT_CASH = '1001';
 const ACCT_AR = '1100';
@@ -115,8 +116,9 @@ export class AddPaymentUseCase {
     });
 
     const accountingEnabled = this.isAccountingEnabled();
+    const ledgersEnabled = this.isLedgersEnabled();
     const effectiveCustomerId = sale.customerId || input.customerId;
-    if (accountingEnabled && effectiveCustomerId) {
+    if (ledgersEnabled && effectiveCustomerId) {
       const balanceBefore = this.customerLedgerRepo.getLastBalanceSync(effectiveCustomerId);
       this.customerLedgerRepo.createSync({
         customerId: effectiveCustomerId,
@@ -128,11 +130,9 @@ export class AddPaymentUseCase {
         notes: input.notes || `Payment for sale #${sale.invoiceNumber}`,
         createdBy: userId,
       });
-    } else if (accountingEnabled) {
-      // Keep compatibility for older aggregate fields if no ledger customer link exists.
-      if (sale.customerId) {
-        this.customerRepo.updateDebt(sale.customerId, -actualPaymentAmount);
-      }
+    } else if (!ledgersEnabled && sale.customerId) {
+      // Legacy fallback when ledgers are intentionally disabled.
+      this.customerRepo.updateDebt(sale.customerId, -actualPaymentAmount);
     }
 
     if (accountingEnabled) {
@@ -182,7 +182,7 @@ export class AddPaymentUseCase {
       description: `Customer payment #${paymentId}`,
       sourceType: 'payment',
       sourceId: paymentId,
-      isPosted: true,
+      isPosted: false,
       isReversed: false,
       totalAmount: amount,
       currency,
@@ -197,7 +197,17 @@ export class AddPaymentUseCase {
 
   private isAccountingEnabled(): boolean {
     if (!this.settingsRepo) return true;
-    const value = this.settingsRepo.get('accounting.enabled');
+    const value =
+      this.settingsRepo.get(MODULE_SETTING_KEYS.ACCOUNTING_ENABLED) ??
+      this.settingsRepo.get('modules.accounting.enabled');
+    return value !== 'false';
+  }
+
+  private isLedgersEnabled(): boolean {
+    if (!this.settingsRepo) return true;
+    const value =
+      this.settingsRepo.get(MODULE_SETTING_KEYS.LEDGERS_ENABLED) ??
+      this.settingsRepo.get('modules.ledgers.enabled');
     return value !== 'false';
   }
 }
diff --git a/packages/core/src/use-cases/AdjustProductStockUseCase.ts b/packages/core/src/use-cases/AdjustProductStockUseCase.ts
index 2205025..8cd2398 100644
--- a/packages/core/src/use-cases/AdjustProductStockUseCase.ts
+++ b/packages/core/src/use-cases/AdjustProductStockUseCase.ts
@@ -1,6 +1,8 @@
 import { IProductRepository } from '../interfaces/IProductRepository.js';
 import { IInventoryRepository } from '../interfaces/IInventoryRepository.js';
 import { IAccountingRepository } from '../interfaces/IAccountingRepository.js';
+import { IAuditRepository } from '../interfaces/IAuditRepository.js';
+import { AuditService } from '../services/AuditService.js';
 import { InventoryMovement } from '../entities/InventoryMovement.js';
 import { NotFoundError, ValidationError, InsufficientStockError } from '../errors/DomainErrors.js';
 
@@ -20,11 +22,16 @@ export interface AdjustStockInput {
 }
 
 export class AdjustProductStockUseCase {
+  private auditService: AuditService;
+
   constructor(
     private productRepo: IProductRepository,
     private inventoryRepo: IInventoryRepository,
-    private accountingRepo?: IAccountingRepository
-  ) {}
+    private accountingRepo?: IAccountingRepository,
+    auditRepo?: IAuditRepository
+  ) {
+    this.auditService = new AuditService(auditRepo as IAuditRepository);
+  }
 
   executeCommitPhase(input: AdjustStockInput, userId: number): InventoryMovement {
     if (!Number.isInteger(input.quantityChange)) {
@@ -80,7 +87,12 @@ export class AdjustProductStockUseCase {
       this.productRepo.update(input.productId, { status: 'available' });
     }
 
-    this.createAdjustmentJournalIfPossible(product.costPrice, input.quantityChange, movement.id, userId);
+    this.createAdjustmentJournalIfPossible(
+      product.costPrice,
+      input.quantityChange,
+      movement.id,
+      userId
+    );
 
     return movement;
   }
@@ -157,6 +169,23 @@ export class AdjustProductStockUseCase {
   }
 
   async execute(input: AdjustStockInput, userId: number): Promise<InventoryMovement> {
-    return this.executeCommitPhase(input, userId);
+    const movement = this.executeCommitPhase(input, userId);
+    // Fire-and-forget audit
+    this.auditService
+      .logAction(
+        userId,
+        'stock:adjust',
+        'product',
+        input.productId,
+        `Stock adjusted by ${input.quantityChange} for product ${input.productId}`,
+        {
+          quantityChange: input.quantityChange,
+          reason: input.reason || 'manual',
+          batchId: input.batchId,
+          movementId: movement.id,
+        }
+      )
+      .catch(() => {});
+    return movement;
   }
 }
diff --git a/packages/core/src/use-cases/CheckInitialSetupUseCase.ts b/packages/core/src/use-cases/CheckInitialSetupUseCase.ts
index 6ff0304..dba07cb 100644
--- a/packages/core/src/use-cases/CheckInitialSetupUseCase.ts
+++ b/packages/core/src/use-cases/CheckInitialSetupUseCase.ts
@@ -5,6 +5,7 @@ export interface SetupStatus {
   isInitialized: boolean;
   hasUsers: boolean;
   hasCompanyInfo: boolean;
+  wizardCompleted: boolean;
 }
 
 export class CheckInitialSetupUseCase {
@@ -17,6 +18,10 @@ export class CheckInitialSetupUseCase {
     // Primary flag — set atomically at the end of InitializeAppUseCase
     const initialized = this.settingsRepo.get('app_initialized');
     const isInitialized = initialized === 'true';
+    const wizardFlag =
+      this.settingsRepo.get('setup.wizardCompleted') ??
+      this.settingsRepo.get('setup.wizard_completed');
+    const wizardCompleted = wizardFlag === null ? isInitialized : wizardFlag === 'true';
 
     // Fallback checks for partial-setup detection
     const userCount = this.userRepo.count();
@@ -38,6 +43,7 @@ export class CheckInitialSetupUseCase {
       isInitialized,
       hasUsers,
       hasCompanyInfo,
+      wizardCompleted,
     };
   }
 }
diff --git a/packages/core/src/use-cases/CreateProductUseCase.ts b/packages/core/src/use-cases/CreateProductUseCase.ts
index c50bca7..2fcd52e 100644
--- a/packages/core/src/use-cases/CreateProductUseCase.ts
+++ b/packages/core/src/use-cases/CreateProductUseCase.ts
@@ -1,9 +1,18 @@
 import { IProductRepository } from '../interfaces/IProductRepository.js';
+import { IAuditRepository } from '../interfaces/IAuditRepository.js';
+import { AuditService } from '../services/AuditService.js';
 import { Product, ProductInput, ProductSchema } from '../entities/Product.js';
 import { ValidationError } from '../errors/DomainErrors.js';
 
 export class CreateProductUseCase {
-  constructor(private productRepo: IProductRepository) {}
+  private auditService: AuditService;
+
+  constructor(
+    private productRepo: IProductRepository,
+    private auditRepo?: IAuditRepository
+  ) {
+    this.auditService = new AuditService(auditRepo as IAuditRepository);
+  }
 
   async execute(productData: ProductInput): Promise<Product> {
     let product: Product;
@@ -29,6 +38,22 @@ export class CreateProductUseCase {
       throw new ValidationError('Stock must be non-negative');
     }
 
-    return await this.productRepo.create(product);
+    const created = await this.productRepo.create(product);
+    // Fire-and-forget audit
+    this.auditService
+      .logCreate(
+        0,
+        'product',
+        created.id!,
+        {
+          name: created.name,
+          costPrice: created.costPrice,
+          sellingPrice: created.sellingPrice,
+          stock: created.stock,
+        },
+        `Product "${created.name}" created`
+      )
+      .catch(() => {});
+    return created;
   }
 }
diff --git a/packages/core/src/use-cases/CreatePurchaseUseCase.ts b/packages/core/src/use-cases/CreatePurchaseUseCase.ts
index 0eb4486..5f4db19 100644
--- a/packages/core/src/use-cases/CreatePurchaseUseCase.ts
+++ b/packages/core/src/use-cases/CreatePurchaseUseCase.ts
@@ -7,6 +7,8 @@ import { IPaymentRepository } from '../interfaces/IPaymentRepository.js';
 import { ISupplierLedgerRepository } from '../interfaces/ISupplierLedgerRepository.js';
 import { IAccountingRepository } from '../interfaces/IAccountingRepository.js';
 import { ISettingsRepository } from '../interfaces/ISettingsRepository.js';
+import { IAuditRepository } from '../interfaces/IAuditRepository.js';
+import { AuditService } from '../services/AuditService.js';
 import { ValidationError } from '../errors/DomainErrors.js';
 
 const ACCT_CASH = '1001';
@@ -45,14 +47,19 @@ export interface CreatePurchaseCommitResult {
 }
 
 export class CreatePurchaseUseCase {
+  private auditService: AuditService;
+
   constructor(
     private purchaseRepository: IPurchaseRepository,
     private supplierRepository: ISupplierRepository,
     private paymentRepository: IPaymentRepository,
     private supplierLedgerRepository: ISupplierLedgerRepository,
     private accountingRepository: IAccountingRepository,
-    private settingsRepository?: ISettingsRepository
-  ) {}
+    private settingsRepository?: ISettingsRepository,
+    auditRepo?: IAuditRepository
+  ) {
+    this.auditService = new AuditService(auditRepo as IAuditRepository);
+  }
 
   executeCommitPhase(input: CreatePurchaseInput, userId: number): CreatePurchaseCommitResult {
     if (!input.items || input.items.length === 0) {
@@ -137,7 +144,7 @@ export class CreatePurchaseUseCase {
       } as any);
     }
 
-    if (this.isAccountingEnabled() && remainingAmount > 0) {
+    if (this.isLedgersEnabled() && remainingAmount > 0) {
       const balanceBefore = this.supplierLedgerRepository.getLastBalanceSync(
         createdPurchase.supplierId
       );
@@ -226,7 +233,7 @@ export class CreatePurchaseUseCase {
       description: `Purchase #${purchase.invoiceNumber}`,
       sourceType: 'purchase',
       sourceId: purchase.id,
-      isPosted: true,
+      isPosted: false,
       isReversed: false,
       totalAmount: purchase.total,
       currency: purchase.currency || 'IQD',
@@ -236,12 +243,38 @@ export class CreatePurchaseUseCase {
   }
 
   async execute(input: CreatePurchaseInput, userId = 1): Promise<Purchase> {
-    return this.executeCommitPhase(input, userId).createdPurchase;
+    const result = this.executeCommitPhase(input, userId);
+    // Fire-and-forget audit
+    this.auditService
+      .logCreate(
+        userId,
+        'purchase',
+        result.createdPurchase.id!,
+        {
+          invoiceNumber: result.createdPurchase.invoiceNumber,
+          total: result.createdPurchase.total,
+          supplierId: result.createdPurchase.supplierId,
+          itemCount: result.createdPurchase.items?.length,
+        },
+        `Purchase #${result.createdPurchase.invoiceNumber} created`
+      )
+      .catch(() => {});
+    return result.createdPurchase;
   }
 
   private isAccountingEnabled(): boolean {
     if (!this.settingsRepository) return true;
-    const value = this.settingsRepository.get('accounting.enabled');
+    const value =
+      this.settingsRepository.get('accounting.enabled') ??
+      this.settingsRepository.get('modules.accounting.enabled');
+    return value !== 'false';
+  }
+
+  private isLedgersEnabled(): boolean {
+    if (!this.settingsRepository) return true;
+    const value =
+      this.settingsRepository.get('ledgers.enabled') ??
+      this.settingsRepository.get('modules.ledgers.enabled');
     return value !== 'false';
   }
 }
diff --git a/packages/core/src/use-cases/CreateSaleUseCase.ts b/packages/core/src/use-cases/CreateSaleUseCase.ts
index 13208a3..60fc22f 100644
--- a/packages/core/src/use-cases/CreateSaleUseCase.ts
+++ b/packages/core/src/use-cases/CreateSaleUseCase.ts
@@ -10,6 +10,7 @@ import { IAuditRepository } from '../interfaces/IAuditRepository.js';
 import { Sale } from '../entities/Sale.js';
 import type { PaymentMethod } from '../entities/Payment.js';
 import type { JournalLine } from '../entities/Accounting.js';
+import type { IFifoDepletionService, BatchDepletion } from '../services/FifoDepletionService.js';
 import {
   ValidationError,
   NotFoundError,
@@ -66,6 +67,7 @@ export interface CreateSaleCommitResult {
 
 type CreateSaleDiagnostics = {
   inventoryMovementsCreated: number;
+  fifoUsed: boolean;
   paymentCreated: { created: boolean; reason: string };
   journalCreated: { created: boolean; reason: string; missingAccountCodes?: string[] };
   customerLedgerCreated: { created: boolean; reason: string };
@@ -83,7 +85,8 @@ export class CreateSaleUseCase {
     private inventoryRepo: IInventoryRepository,
     private accountingRepo: IAccountingRepository,
     private customerLedgerRepo: ICustomerLedgerRepository,
-    auditRepo?: IAuditRepository
+    auditRepo?: IAuditRepository,
+    private fifoService?: IFifoDepletionService
   ) {
     this.auditService = new AuditService(auditRepo as IAuditRepository);
   }
@@ -91,6 +94,7 @@ export class CreateSaleUseCase {
   executeCommitPhase(input: CreateSaleInput, userId: number): CreateSaleCommitResult {
     const diagnostics: CreateSaleDiagnostics = {
       inventoryMovementsCreated: 0,
+      fifoUsed: !!this.fifoService,
       paymentCreated: { created: false, reason: 'not-executed' },
       journalCreated: { created: false, reason: 'not-executed' },
       customerLedgerCreated: { created: false, reason: 'not-executed' },
@@ -147,10 +151,9 @@ export class CreateSaleUseCase {
       discount: number;
       subtotal: number;
       costPrice: number;
+      fallbackCostTotal: number;
     }[] = [];
 
-    let totalCOGS = 0;
-
     for (const item of input.items) {
       const product = this.productRepo.findById(item.productId);
       if (!product) {
@@ -206,18 +209,30 @@ export class CreateSaleUseCase {
 
       const quantityBase = item.quantity * unitFactor;
 
-      // Stock check against cached stock (products.stock)
-      if ((product.stock || 0) < quantityBase) {
-        throw new InsufficientStockError(`Insufficient stock for ${product.name}`, {
-          productId: product.id,
-          productName: product.name,
-          available: product.stock || 0,
-          requested: quantityBase,
-        });
+      // Stock check — use FIFO service if available, else fall back to cached stock
+      if (this.fifoService) {
+        const batchStock = this.fifoService.getAvailableStock(product.id);
+        if (batchStock < quantityBase) {
+          throw new InsufficientStockError(`Insufficient batch stock for ${product.name}`, {
+            productId: product.id,
+            productName: product.name,
+            available: batchStock,
+            requested: quantityBase,
+          });
+        }
+      } else {
+        if ((product.stock || 0) < quantityBase) {
+          throw new InsufficientStockError(`Insufficient stock for ${product.name}`, {
+            productId: product.id,
+            productName: product.name,
+            available: product.stock || 0,
+            requested: quantityBase,
+          });
+        }
       }
 
-      const itemCostTotal = quantityBase * product.costPrice;
-      totalCOGS += itemCostTotal;
+      // COGS will be calculated from FIFO batch costs if available
+      const fallbackCostTotal = quantityBase * product.costPrice;
 
       saleItems.push({
         productId: product.id,
@@ -231,6 +246,7 @@ export class CreateSaleUseCase {
         discount: item.discount || 0,
         subtotal: item.quantity * unitPrice - (item.discount || 0) * item.quantity,
         costPrice: product.costPrice,
+        fallbackCostTotal,
       });
     }
 
@@ -294,37 +310,74 @@ export class CreateSaleUseCase {
 
     const createdSale = this.saleRepo.create(saleData);
 
-    // ── Step 6 & 7: Inventory movements + stock update ──────────
+    // ── Step 6 & 7: FIFO batch depletion + inventory movements ──
+    let totalCOGS = 0;
+
     for (const item of saleItems) {
       const currentProduct = this.productRepo.findById(item.productId)!;
       const stockBefore = currentProduct.stock || 0;
-      const stockAfter = stockBefore - item.quantityBase;
 
-      // Create inventory movement (immutable ledger entry)
-      this.inventoryRepo.createMovementSync({
-        productId: item.productId,
-        batchId: item.batchId,
-        movementType: 'out',
-        reason: 'sale',
-        quantityBase: item.quantityBase,
-        unitName: item.unitName,
-        unitFactor: item.unitFactor,
-        stockBefore,
-        stockAfter,
-        costPerUnit: item.costPrice,
-        totalCost: item.quantityBase * item.costPrice,
-        sourceType: 'sale',
-        sourceId: createdSale.id,
-        notes: `Sale #${createdSale.invoiceNumber}`,
-        createdBy: userId,
-      });
-      diagnostics.inventoryMovementsCreated += 1;
+      if (this.fifoService) {
+        // ── FIFO path: deplete from oldest batches, calculate real COGS ──
+        const fifoResult = this.fifoService.deplete(item.productId, item.quantityBase);
+        totalCOGS += fifoResult.totalCost;
+
+        // Create one inventory movement per batch depletion for full traceability
+        let runningStock = stockBefore;
+        for (const depletion of fifoResult.depletions) {
+          const newStock = runningStock - depletion.quantity;
+          this.inventoryRepo.createMovementSync({
+            productId: item.productId,
+            batchId: depletion.batchId,
+            movementType: 'out',
+            reason: 'sale',
+            quantityBase: depletion.quantity,
+            unitName: item.unitName,
+            unitFactor: item.unitFactor,
+            stockBefore: runningStock,
+            stockAfter: newStock,
+            costPerUnit: depletion.costPerUnit,
+            totalCost: depletion.totalCost,
+            sourceType: 'sale',
+            sourceId: createdSale.id,
+            notes: `Sale #${createdSale.invoiceNumber} (batch ${depletion.batchId})`,
+            createdBy: userId,
+          });
+          diagnostics.inventoryMovementsCreated += 1;
+          runningStock = newStock;
+        }
+
+        // Update products.stock cache (one atomic update per product)
+        this.productRepo.updateStock(item.productId, -item.quantityBase);
+      } else {
+        // ── Legacy path: no FIFO, flat stock deduction ──
+        const stockAfter = stockBefore - item.quantityBase;
+        totalCOGS += item.fallbackCostTotal;
 
-      // Update products.stock cache
-      this.productRepo.updateStock(item.productId, -item.quantityBase);
+        this.inventoryRepo.createMovementSync({
+          productId: item.productId,
+          batchId: item.batchId,
+          movementType: 'out',
+          reason: 'sale',
+          quantityBase: item.quantityBase,
+          unitName: item.unitName,
+          unitFactor: item.unitFactor,
+          stockBefore,
+          stockAfter,
+          costPerUnit: item.costPrice,
+          totalCost: item.fallbackCostTotal,
+          sourceType: 'sale',
+          sourceId: createdSale.id,
+          notes: `Sale #${createdSale.invoiceNumber}`,
+          createdBy: userId,
+        });
+        diagnostics.inventoryMovementsCreated += 1;
 
-      if (item.batchId) {
-        this.productRepo.updateBatchStock(item.batchId, -item.quantityBase);
+        this.productRepo.updateStock(item.productId, -item.quantityBase);
+
+        if (item.batchId) {
+          this.productRepo.updateBatchStock(item.batchId, -item.quantityBase);
+        }
       }
     }
 
@@ -350,6 +403,7 @@ export class CreateSaleUseCase {
 
     // ── Step 9: Accounting journal entry ─────────────────────────
     const accountingEnabled = this.isAccountingEnabled();
+    const ledgersEnabled = this.isLedgersEnabled();
     diagnostics.journalCreated = accountingEnabled
       ? this.createSaleJournalEntry(
           createdSale,
@@ -362,8 +416,8 @@ export class CreateSaleUseCase {
       : { created: false, reason: 'accounting-disabled' };
 
     // ── Step 10: Customer ledger + debt ──────────────────────────
-    if (!accountingEnabled) {
-      diagnostics.customerLedgerCreated = { created: false, reason: 'accounting-disabled' };
+    if (!ledgersEnabled) {
+      diagnostics.customerLedgerCreated = { created: false, reason: 'ledgers-disabled' };
     } else if (input.customerId && remainingAmount > 0) {
       const currentDebt = this.customerLedgerRepo.getLastBalanceSync(input.customerId);
       const newBalance = currentDebt + remainingAmount;
@@ -502,7 +556,7 @@ export class CreateSaleUseCase {
       description: `Sale #${sale.invoiceNumber}`,
       sourceType: 'sale',
       sourceId: sale.id,
-      isPosted: true,
+      isPosted: false,
       isReversed: false,
       totalAmount: sale.total,
       currency,
@@ -513,7 +567,15 @@ export class CreateSaleUseCase {
   }
 
   private isAccountingEnabled(): boolean {
-    const value = this.settingsRepo.get('accounting.enabled');
+    const value =
+      this.settingsRepo.get('accounting.enabled') ??
+      this.settingsRepo.get('modules.accounting.enabled');
+    return value !== 'false';
+  }
+
+  private isLedgersEnabled(): boolean {
+    const value =
+      this.settingsRepo.get('ledgers.enabled') ?? this.settingsRepo.get('modules.ledgers.enabled');
     return value !== 'false';
   }
 
diff --git a/packages/core/src/use-cases/DeleteProductUseCase.ts b/packages/core/src/use-cases/DeleteProductUseCase.ts
index a0647c8..7839665 100644
--- a/packages/core/src/use-cases/DeleteProductUseCase.ts
+++ b/packages/core/src/use-cases/DeleteProductUseCase.ts
@@ -1,9 +1,20 @@
 import { IProductRepository } from '../interfaces/IProductRepository.js';
+import { IAuditRepository } from '../interfaces/IAuditRepository.js';
+import { AuditService } from '../services/AuditService.js';
 
 export class DeleteProductUseCase {
-  constructor(private productRepo: IProductRepository) {}
+  private auditService: AuditService;
+
+  constructor(
+    private productRepo: IProductRepository,
+    private auditRepo?: IAuditRepository
+  ) {
+    this.auditService = new AuditService(auditRepo as IAuditRepository);
+  }
 
   async execute(id: number): Promise<void> {
-    return await this.productRepo.delete(id);
+    await this.productRepo.delete(id);
+    // Fire-and-forget audit
+    this.auditService.logDelete(0, 'product', id, { id }).catch(() => {});
   }
 }
diff --git a/packages/core/src/use-cases/InitializeAppUseCase.ts b/packages/core/src/use-cases/InitializeAppUseCase.ts
index 9b1c3b6..1ffd98c 100644
--- a/packages/core/src/use-cases/InitializeAppUseCase.ts
+++ b/packages/core/src/use-cases/InitializeAppUseCase.ts
@@ -71,11 +71,15 @@ export class InitializeAppUseCase {
       isActive: true,
     } as User);
 
-    // 7. Set initialized flag (CRITICAL: must be LAST for crash safety)
+    // 7. Force setup wizard to remain incomplete until wizard settings are committed.
+    this.settingsRepo.set('setup.wizardCompleted', 'false');
+    this.settingsRepo.set('setup.wizard_completed', 'false');
+
+    // 8. Set initialized flag (CRITICAL: must be LAST for crash safety)
     this.settingsRepo.set('app_initialized', 'true');
     this.settingsRepo.set('initialized_at', new Date().toISOString());
 
-    // 8. Return success (without password)
+    // 9. Return success (without password)
     const { password, ...adminWithoutPassword } = admin;
     return {
       success: true,
diff --git a/packages/core/src/use-cases/UpdateProductUseCase.ts b/packages/core/src/use-cases/UpdateProductUseCase.ts
index d4ffb5d..a1713a0 100644
--- a/packages/core/src/use-cases/UpdateProductUseCase.ts
+++ b/packages/core/src/use-cases/UpdateProductUseCase.ts
@@ -1,9 +1,18 @@
 import { IProductRepository } from '../interfaces/IProductRepository.js';
+import { IAuditRepository } from '../interfaces/IAuditRepository.js';
+import { AuditService } from '../services/AuditService.js';
 import { Product } from '../entities/Product.js';
 import { ValidationError } from '../errors/DomainErrors.js';
 
 export class UpdateProductUseCase {
-  constructor(private productRepo: IProductRepository) {}
+  private auditService: AuditService;
+
+  constructor(
+    private productRepo: IProductRepository,
+    private auditRepo?: IAuditRepository
+  ) {
+    this.auditService = new AuditService(auditRepo as IAuditRepository);
+  }
 
   async execute(id: number, productData: Partial<Product>): Promise<Product> {
     if (productData.name !== undefined && productData.name.trim().length === 0) {
@@ -22,6 +31,19 @@ export class UpdateProductUseCase {
       throw new ValidationError('Stock must be non-negative');
     }
 
-    return await this.productRepo.update(id, productData);
+    const updated = await this.productRepo.update(id, productData);
+    // Fire-and-forget audit
+    this.auditService
+      .logUpdate(
+        0,
+        'product',
+        id,
+        Object.fromEntries(
+          Object.entries(productData).map(([k, v]) => [k, { old: undefined, new: v }])
+        ),
+        `Product #${id} updated`
+      )
+      .catch(() => {});
+    return updated;
   }
 }
diff --git a/packages/data/drizzle/meta/_journal.json b/packages/data/drizzle/meta/_journal.json
index b6f91c7..d8a2fe2 100644
--- a/packages/data/drizzle/meta/_journal.json
+++ b/packages/data/drizzle/meta/_journal.json
@@ -50,6 +50,20 @@
       "when": 1771305600000,
       "tag": "0006_plan_a_idempotency",
       "breakpoints": true
+    },
+    {
+      "idx": 7,
+      "version": "6",
+      "when": 1771900800000,
+      "tag": "0007_setup_wizard_and_posting",
+      "breakpoints": true
+    },
+    {
+      "idx": 8,
+      "version": "6",
+      "when": 1772100000000,
+      "tag": "0008_canonical_setup_keys",
+      "breakpoints": true
     }
   ]
 }
diff --git a/packages/data/src/db.ts b/packages/data/src/db.ts
index 9120340..0232bf8 100644
--- a/packages/data/src/db.ts
+++ b/packages/data/src/db.ts
@@ -25,6 +25,10 @@ export function createDb(sqlitePath: string): DbConnection {
   sqlite.pragma('journal_mode = WAL');
   sqlite.pragma('foreign_keys = ON');
   sqlite.pragma('synchronous = NORMAL');
+  sqlite.pragma('busy_timeout = 5000');
+  sqlite.pragma('cache_size = -8000'); // 8 MB
+  sqlite.pragma('temp_store = MEMORY');
+  sqlite.pragma('mmap_size = 268435456'); // 256 MB
 
   const db = drizzle(sqlite, { schema });
 
diff --git a/packages/data/src/index.ts b/packages/data/src/index.ts
index 5b5c610..ea6484a 100644
--- a/packages/data/src/index.ts
+++ b/packages/data/src/index.ts
@@ -15,6 +15,8 @@ export * from './repositories/SqliteCustomerLedgerRepository.js';
 export * from './repositories/SqliteAccountingRepository.js';
 export * from './repositories/SqliteSupplierLedgerRepository.js';
 export * from './repositories/SqliteProductWorkspaceRepository.js';
+export * from './repositories/SqlitePostingRepository.js';
+export * from './services/SqliteFifoService.js';
 export * as schema from './schema/schema.js';
 export * from './seed.js';
 export { DbConnection as DatabaseType } from './db.js';
diff --git a/packages/data/src/repositories/SqliteProductRepository.ts b/packages/data/src/repositories/SqliteProductRepository.ts
index f039ad6..1b66175 100644
--- a/packages/data/src/repositories/SqliteProductRepository.ts
+++ b/packages/data/src/repositories/SqliteProductRepository.ts
@@ -33,22 +33,26 @@ export class SqliteProductRepository implements IProductRepository {
       conditions.push(lte(products.stock, products.minStock));
     }
     if (params?.expiringSoonOnly) {
-      const cutoff = new Date();
-      cutoff.setDate(cutoff.getDate() + 30);
-      const cutoffDate = cutoff.toISOString().slice(0, 10);
-      conditions.push(sql`EXISTS (
-        SELECT 1
-        FROM product_batches pb
-        WHERE pb.product_id = ${products.id}
-          AND pb.quantity_on_hand > 0
-          AND pb.expiry_date IS NOT NULL
-          AND pb.expiry_date <= ${cutoffDate}
-      )`);
+      conditions.push(sql`
+        EXISTS (
+          SELECT 1
+          FROM product_batches pb
+          WHERE pb.product_id = ${products.id}
+            AND pb.quantity_on_hand > 0
+            AND pb.expiry_date IS NOT NULL
+            AND date(pb.expiry_date) <= date('now','localtime','+30 days')
+            AND date(pb.expiry_date) >= date('now','localtime') -- اختياري: يستبعد المنتهي
+        )
+      `);
     }
 
     const whereClause = conditions.length ? and(...conditions) : undefined;
 
-    const query = this.db.select().from(products).where(whereClause).orderBy(desc(products.updatedAt));
+    const query = this.db
+      .select()
+      .from(products)
+      .where(whereClause)
+      .orderBy(desc(products.updatedAt));
 
     if (params?.limit) query.limit(params.limit);
     if (params?.offset) query.offset(params.offset);
@@ -200,11 +204,7 @@ export class SqliteProductRepository implements IProductRepository {
       .where(eq(productUnits.productId, productId))
       .run();
 
-    this.db
-      .update(productUnits)
-      .set({ isDefault: true })
-      .where(eq(productUnits.id, unitId))
-      .run();
+    this.db.update(productUnits).set({ isDefault: true }).where(eq(productUnits.id, unitId)).run();
   }
 
   findBatchesByProductId(productId: number): ProductBatch[] {
diff --git a/packages/data/src/repositories/SqlitePurchaseRepository.ts b/packages/data/src/repositories/SqlitePurchaseRepository.ts
index a0c0645..08fb53c 100644
--- a/packages/data/src/repositories/SqlitePurchaseRepository.ts
+++ b/packages/data/src/repositories/SqlitePurchaseRepository.ts
@@ -243,6 +243,10 @@ export class SqlitePurchaseRepository implements IPurchaseRepository {
   }
 
   async findById(id: number): Promise<Purchase | null> {
+    return this.findByIdSync(id);
+  }
+
+  findByIdSync(id: number): Purchase | null {
     const item = this.db.select().from(purchases).where(eq(purchases.id, id)).get();
     if (!item) return null;
 
@@ -270,6 +274,10 @@ export class SqlitePurchaseRepository implements IPurchaseRepository {
   }
 
   async updateStatus(id: number, status: string): Promise<void> {
+    this.updateStatusSync(id, status);
+  }
+
+  updateStatusSync(id: number, status: string): void {
     this.db
       .update(purchases)
       .set({ status, updatedAt: new Date().toISOString() })
@@ -278,6 +286,10 @@ export class SqlitePurchaseRepository implements IPurchaseRepository {
   }
 
   async updatePayment(id: number, paidAmount: number, remainingAmount: number): Promise<void> {
+    this.updatePaymentSync(id, paidAmount, remainingAmount);
+  }
+
+  updatePaymentSync(id: number, paidAmount: number, remainingAmount: number): void {
     this.db
       .update(purchases)
       .set({
diff --git a/packages/data/src/schema/schema.ts b/packages/data/src/schema/schema.ts
index 730fb5c..e9fe9ea 100644
--- a/packages/data/src/schema/schema.ts
+++ b/packages/data/src/schema/schema.ts
@@ -342,6 +342,32 @@ export const accounts = sqliteTable('accounts', {
   createdAt: text('created_at').default(sql`(datetime('now','localtime'))`),
 });
 
+// ═══════════════════════════════════════════════════════════════
+// POSTING BATCHES (Batch posting of journal entries)
+// ═══════════════════════════════════════════════════════════════
+
+export const postingBatches = sqliteTable(
+  'posting_batches',
+  {
+    id: integer('id').primaryKey({ autoIncrement: true }),
+    periodType: text('period_type').notNull().default('day'),
+    periodStart: text('period_start').notNull(),
+    periodEnd: text('period_end').notNull(),
+    entriesCount: integer('entries_count').notNull().default(0),
+    totalAmount: integer('total_amount').notNull().default(0),
+    status: text('status').notNull().default('posted'),
+    postedAt: text('posted_at')
+      .notNull()
+      .default(sql`(datetime('now','localtime'))`),
+    postedBy: integer('posted_by'),
+    notes: text('notes'),
+    createdAt: text('created_at').default(sql`(datetime('now','localtime'))`),
+  },
+  (table) => [
+    index('idx_posting_batches_period').on(table.periodType, table.periodStart, table.periodEnd),
+  ]
+);
+
 // ═══════════════════════════════════════════════════════════════
 // JOURNAL ENTRIES (Header)
 // ═══════════════════════════════════════════════════════════════
@@ -360,6 +386,7 @@ export const journalEntries = sqliteTable(
     isPosted: integer('is_posted', { mode: 'boolean' }).default(true),
     isReversed: integer('is_reversed', { mode: 'boolean' }).default(false),
     reversalOfId: integer('reversal_of_id'),
+    postingBatchId: integer('posting_batch_id'),
     totalAmount: integer('total_amount').notNull(),
     currency: text('currency').notNull().default('IQD'),
     notes: text('notes'),
